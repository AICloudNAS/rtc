(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var crel=require("crel");var defaults=require("cog/defaults");var extend=require("cog/extend");var quickconnect=require("rtc-quickconnect");var captureconfig=require("rtc-captureconfig");var media=require("rtc-media");var DEFAULT_CONSTRAINTS={video:true,audio:true};module.exports=function(opts){var rtc=new EventEmitter;var constraints=[].concat((opts||{}).capture||[DEFAULT_CONSTRAINTS]);var plugins=(opts||{}).plugins||[];var signalhost=(opts||{}).signaller||"//switchboard.rtc.io";var localStreams=[];var localVideo;var remoteVideo;var captureTargets=constraints.map(parseConstraints).map(function(constraints){return media({constraints:constraints,plugins:plugins})});function announce(){var signaller=rtc.signaller=quickconnect(signalhost,opts);signaller.on("call:started",handleCallStart).on("call:ended",handleCallEnd);localStreams.forEach(function(stream){signaller.addStream(stream)});rtc.emit("ready")}function gotLocalStream(stream){media({stream:stream,plugins:plugins,muted:true}).render(localVideo);localStreams.push(stream);if(localStreams.length>=captureTargets.length){announce()}}function handleCallStart(id,pc,data){var container=crel("div",{"class":"rtc-peer","data-peerid":id});console.log("call started with peer: "+id);pc.getRemoteStreams().forEach(function(stream){media({stream:stream,plugins:plugins}).render(container)});remoteVideo.appendChild(container)}function handleCallEnd(id,pc,data){var el=remoteVideo.querySelector('div[data-peerid="'+id+'"]');if(el){el.parentNode.removeChild(el)}}function parseConstraints(input){if(typeof input=="string"){return captureconfig(input).toConstraints()}return input}captureTargets.forEach(function(target){target.once("capture",gotLocalStream)});localVideo=rtc.local=crel("div",{"class":"rtc-media rtc-localvideo"});remoteVideo=rtc.remote=crel("div",{"class":"rtc-media rtc-remotevideo"});return rtc}},{"cog/defaults":12,"cog/extend":13,crel:35,events:2,"rtc-captureconfig":36,"rtc-media":37,"rtc-quickconnect":41}],2:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{throw TypeError('Uncaught, unspecified "error" event.')}return false}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],3:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],4:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],5:[function(require,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^ -~]/,regexSeparators=/\x2E|\u3002|\uFF0E|\uFF61/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw RangeError(errors[type])}function map(array,fn){var length=array.length;while(length--){array[length]=fn(array[length])}return array}function mapDomain(string,fn){return map(string.split(regexSeparators),fn).join(".")}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(domain){return mapDomain(domain,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(domain){return mapDomain(domain,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.2.4",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],6:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],7:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],8:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":6,"./encode":7}],9:[function(require,module,exports){var punycode=require("punycode");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var rest=url;rest=rest.trim();var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){var domainArray=this.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}this.hostname=newOut.join(".")}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;Object.keys(this).forEach(function(k){result[k]=this[k]},this);result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){Object.keys(relative).forEach(function(k){if(k!=="protocol")result[k]=relative[k]});if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){Object.keys(relative).forEach(function(k){result[k]=relative[k]});result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!isNull(result.pathname)||!isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!isNull(result.pathname)||!isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host};function isString(arg){return typeof arg==="string"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isNull(arg){return arg===null}function isNullOrUndefined(arg){return arg==null}},{punycode:5,querystring:8}],10:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],11:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)
}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("FWaASH"),typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":10,FWaASH:4,inherits:3}],12:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],13:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],14:[function(require,module,exports){"use strict";module.exports=function(input){var isString=typeof input=="string"||input instanceof String;var reNumeric=/^\-?\d+\.?\d*$/;var shouldParse;var firstChar;var lastChar;if(!isString||input.length<2){if(isString&&reNumeric.test(input)){return parseFloat(input)}return input}if(input==="true"||input==="false"){return input==="true"}if(input==="null"){return null}firstChar=input.charAt(0);lastChar=input.charAt(input.length-1);shouldParse=firstChar=="{"&&lastChar=="}"||firstChar=="["&&lastChar=="]"||firstChar=='"'&&lastChar=='"';if(shouldParse){try{return JSON.parse(input)}catch(e){}}return reNumeric.test(input)?parseFloat(input):input}},{}],15:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],16:[function(require,module,exports){"use strict";module.exports=function(fn,delay,opts){var lastExec=(opts||{}).leading!==false?0:Date.now();var trailing=(opts||{}).trailing;var timer;var queuedArgs;var queuedScope;trailing=trailing||trailing===undefined;function invokeDefered(){fn.apply(queuedScope,queuedArgs||[]);lastExec=Date.now()}return function(){var tick=Date.now();var elapsed=tick-lastExec;clearTimeout(timer);if(elapsed<delay){queuedArgs=[].slice.call(arguments,0);queuedScope=this;return trailing&&(timer=setTimeout(invokeDefered,delay-elapsed))}lastExec=tick;fn.apply(this,arguments)}}},{}],17:[function(require,module,exports){"use strict";var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=Dict;function Dict(values,getDefault){if(!(this instanceof Dict)){return new Dict(values,getDefault)}getDefault=getDefault||Function.noop;this.getDefault=getDefault;this.store={};this.length=0;this.addEach(values)}Dict.Dict=Dict;function mangle(key){return"~"+key}function unmangle(mangled){return mangled.slice(1)}Object.addEach(Dict.prototype,GenericCollection.prototype);Object.addEach(Dict.prototype,GenericMap.prototype);Object.addEach(Dict.prototype,PropertyChanges.prototype);Dict.prototype.constructClone=function(values){return new this.constructor(values,this.mangle,this.getDefault)};Dict.prototype.assertString=function(key){if(typeof key!=="string"){throw new TypeError("key must be a string but Got "+key)}};Dict.prototype.get=function(key,defaultValue){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){return this.store[mangled]}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};Dict.prototype.set=function(key,value){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesBeforeMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return false}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}this.length++;this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return true}};Dict.prototype.has=function(key){this.assertString(key);var mangled=mangle(key);return mangled in this.store};Dict.prototype["delete"]=function(key){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangle(key)];this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};Dict.prototype.clear=function(){var key,mangled;for(mangled in this.store){key=unmangle(mangled);if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangled];if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}}this.length=0};Dict.prototype.reduce=function(callback,basis,thisp){for(var mangled in this.store){basis=callback.call(thisp,basis,this.store[mangled],unmangle(mangled),this)}return basis};Dict.prototype.reduceRight=function(callback,basis,thisp){var self=this;var store=this.store;return Object.keys(this.store).reduceRight(function(basis,mangled){return callback.call(thisp,basis,store[mangled],unmangle(mangled),self)},basis)};Dict.prototype.one=function(){var key;for(key in this.store){return this.store[key]}}},{"./generic-collection":20,"./generic-map":21,"./listen/property-changes":26,"./shim":33}],18:[function(require,module,exports){"use strict";var Shim=require("./shim");var Set=require("./fast-set");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=FastMap;function FastMap(values,equals,hash,getDefault){if(!(this instanceof FastMap)){return new FastMap(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.store=new Set(undefined,function keysEqual(a,b){return equals(a.key,b.key)},function keyHash(item){return hash(item.key)});this.length=0;this.addEach(values)}FastMap.FastMap=FastMap;Object.addEach(FastMap.prototype,GenericCollection.prototype);Object.addEach(FastMap.prototype,GenericMap.prototype);Object.addEach(FastMap.prototype,PropertyChanges.prototype);FastMap.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastMap.prototype.log=function(charmap,stringify){stringify=stringify||this.stringify;this.store.log(charmap,stringify)};FastMap.prototype.stringify=function(item,leader){return leader+JSON.stringify(item.key)+": "+JSON.stringify(item.value)}},{"./fast-set":19,"./generic-collection":20,"./generic-map":21,"./listen/property-changes":26,"./shim":33}],19:[function(require,module,exports){"use strict";var Shim=require("./shim");var Dict=require("./dict");var List=require("./list");var GenericCollection=require("./generic-collection");var GenericSet=require("./generic-set");var TreeLog=require("./tree-log");var PropertyChanges=require("./listen/property-changes");var object_has=Object.prototype.hasOwnProperty;module.exports=FastSet;function FastSet(values,equals,hash,getDefault){if(!(this instanceof FastSet)){return new FastSet(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.buckets=new this.Buckets(null,this.Bucket);this.length=0;this.addEach(values)}FastSet.FastSet=FastSet;Object.addEach(FastSet.prototype,GenericCollection.prototype);Object.addEach(FastSet.prototype,GenericSet.prototype);Object.addEach(FastSet.prototype,PropertyChanges.prototype);FastSet.prototype.Buckets=Dict;FastSet.prototype.Bucket=List;FastSet.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastSet.prototype.has=function(value){var hash=this.contentHash(value);return this.buckets.get(hash).has(value)};FastSet.prototype.get=function(value,equals){if(equals){throw new Error("FastSet#get does not support second argument: equals")}var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){return buckets.get(hash).get(value)}else{return this.getDefault(value)}};FastSet.prototype["delete"]=function(value,equals){if(equals){throw new Error("FastSet#delete does not support second argument: equals")}var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){var bucket=buckets.get(hash);if(bucket["delete"](value)){this.length--;if(bucket.length===0){buckets["delete"](hash)}return true}}return false};FastSet.prototype.clear=function(){this.buckets.clear();this.length=0};FastSet.prototype.add=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(!buckets.has(hash)){buckets.set(hash,new this.Bucket(null,this.contentEquals))}if(!buckets.get(hash).has(value)){buckets.get(hash).add(value);this.length++;return true}return false};FastSet.prototype.reduce=function(callback,basis){var thisp=arguments[2];var buckets=this.buckets;var index=0;return buckets.reduce(function(basis,bucket){return bucket.reduce(function(basis,value){return callback.call(thisp,basis,value,index++,this)},basis,this)},basis,this)};FastSet.prototype.one=function(){if(this.length>0){return this.buckets.one().one()}};FastSet.prototype.iterate=function(){return this.buckets.values().flatten().iterate()};FastSet.prototype.log=function(charmap,logNode,callback,thisp){charmap=charmap||TreeLog.unicodeSharp;logNode=logNode||this.logNode;if(!callback){callback=console.log;thisp=console}callback=callback.bind(thisp);var buckets=this.buckets;var hashes=buckets.keys();hashes.forEach(function(hash,index){var branch;var leader;if(index===hashes.length-1){branch=charmap.fromAbove;leader=" "}else if(index===0){branch=charmap.branchDown;leader=charmap.strafe}else{branch=charmap.fromBoth;leader=charmap.strafe}var bucket=buckets.get(hash);callback.call(thisp,branch+charmap.through+charmap.branchDown+" "+hash);bucket.forEach(function(value,node){var branch,below;if(node===bucket.head.prev){branch=charmap.fromAbove;below=" "}else{branch=charmap.fromBoth;below=charmap.strafe}var written;logNode(node,function(line){if(!written){callback.call(thisp,leader+" "+branch+charmap.through+charmap.through+line);written=true}else{callback.call(thisp,leader+" "+below+"  "+line)}},function(line){callback.call(thisp,leader+" "+charmap.strafe+"  "+line)})})})};FastSet.prototype.logNode=function(node,write){var value=node.value;if(Object(value)===value){JSON.stringify(value,null,4).split("\n").forEach(function(line){write(" "+line)})}else{write(" "+value)}}},{"./dict":17,"./generic-collection":20,"./generic-set":23,"./list":24,"./listen/property-changes":26,"./shim":33,"./tree-log":34}],20:[function(require,module,exports){"use strict";module.exports=GenericCollection;function GenericCollection(){throw new Error("Can't construct. GenericCollection is a mixin.")}GenericCollection.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){values.forEach(this.add,this)}else if(typeof values.length==="number"){for(var i=0;i<values.length;i++){this.add(values[i],i)}}else{Object.keys(values).forEach(function(key){this.add(values[key],key)},this)}}return this};GenericCollection.prototype.deleteEach=function(values,equals){values.forEach(function(value){this["delete"](value,equals)},this);return this};GenericCollection.prototype.forEach=function(callback){var thisp=arguments[1];return this.reduce(function(undefined,value,key,object,depth){callback.call(thisp,value,key,object,depth)},undefined)};GenericCollection.prototype.map=function(callback){var thisp=arguments[1];var result=[];this.reduce(function(undefined,value,key,object,depth){result.push(callback.call(thisp,value,key,object,depth))},undefined);return result};GenericCollection.prototype.enumerate=function(start){if(start==null){start=0}var result=[];this.reduce(function(undefined,value){result.push([start++,value])},undefined);return result};GenericCollection.prototype.group=function(callback,thisp,equals){equals=equals||Object.equals;var groups=[];var keys=[];this.forEach(function(value,key,object){var key=callback.call(thisp,value,key,object);var index=keys.indexOf(key,equals);var group;if(index===-1){group=[];groups.push([key,group]);keys.push(key)}else{group=groups[index][1]}group.push(value)});return groups};GenericCollection.prototype.toArray=function(){return this.map(Function.identity)};GenericCollection.prototype.toObject=function(){var object={};this.reduce(function(undefined,value,key){object[key]=value},undefined);return object};GenericCollection.prototype.filter=function(callback){var thisp=arguments[1];var result=this.constructClone();this.reduce(function(undefined,value,key,object,depth){if(callback.call(thisp,value,key,object,depth)){result.add(value,key)}},undefined);return result};GenericCollection.prototype.every=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result&&callback.call(thisp,value,key,object,depth)},true)};GenericCollection.prototype.some=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result||callback.call(thisp,value,key,object,depth)},false)};GenericCollection.prototype.all=function(){return this.every(Boolean)};GenericCollection.prototype.any=function(){return this.some(Boolean)};GenericCollection.prototype.min=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)<0?value:result}},undefined)};GenericCollection.prototype.max=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)>0?value:result}},undefined)};GenericCollection.prototype.sum=function(zero){zero=zero===undefined?0:zero;return this.reduce(function(a,b){return a+b},zero)};GenericCollection.prototype.average=function(zero){var sum=zero===undefined?0:zero;var count=zero===undefined?0:zero;this.reduce(function(undefined,value){sum+=value;count+=1},undefined);return sum/count};GenericCollection.prototype.concat=function(){var result=this.constructClone(this);for(var i=0;i<arguments.length;i++){result.addEach(arguments[i])}return result};GenericCollection.prototype.flatten=function(){var self=this;return this.reduce(function(result,array){array.forEach(function(value){this.push(value)},result,self);return result},[])};GenericCollection.prototype.zip=function(){var table=Array.prototype.slice.call(arguments);table.unshift(this);return Array.unzip(table)};GenericCollection.prototype.join=function(delimiter){return this.reduce(function(result,string){return result+delimiter+string})};GenericCollection.prototype.sorted=function(compare,by,order){compare=compare||this.contentCompare||Object.compare;if(compare.by){by=compare.by;compare=compare.compare||this.contentCompare||Object.compare}else{by=by||Function.identity}if(order===undefined)order=1;return this.map(function(item){return{by:by(item),value:item}}).sort(function(a,b){return compare(a.by,b.by)*order}).map(function(pair){return pair.value})};GenericCollection.prototype.reversed=function(){return this.constructClone(this).reverse()};GenericCollection.prototype.clone=function(depth,memo){if(depth===undefined){depth=Infinity}else if(depth===0){return this}var clone=this.constructClone();this.forEach(function(value,key){clone.add(Object.clone(value,depth-1,memo),key)},this);return clone};GenericCollection.prototype.only=function(){if(this.length===1){return this.one()}};GenericCollection.prototype.iterator=function(){return this.iterate.apply(this,arguments)};require("./shim-array")},{"./shim-array":29}],21:[function(require,module,exports){"use strict";var Object=require("./shim-object");var MapChanges=require("./listen/map-changes");var PropertyChanges=require("./listen/property-changes");module.exports=GenericMap;function GenericMap(){throw new Error("Can't construct. GenericMap is a mixin.")}Object.addEach(GenericMap.prototype,MapChanges.prototype);Object.addEach(GenericMap.prototype,PropertyChanges.prototype);GenericMap.prototype.isMap=true;GenericMap.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){if(values.isMap===true){values.forEach(function(value,key){this.set(key,value)},this)}else{values.forEach(function(pair){this.set(pair[0],pair[1])},this)}}else{Object.keys(values).forEach(function(key){this.set(key,values[key])},this)}}return this};GenericMap.prototype.get=function(key,defaultValue){var item=this.store.get(new this.Item(key));if(item){return item.value}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};GenericMap.prototype.set=function(key,value){var item=new this.Item(key,value);var found=this.store.get(item);var grew=false;if(found){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,found.value)}found.value=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}if(this.store.add(item)){this.length++;grew=true}if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}return grew};GenericMap.prototype.add=function(value,key){return this.set(key,value)};GenericMap.prototype.has=function(key){return this.store.has(new this.Item(key))};GenericMap.prototype["delete"]=function(key){var item=new this.Item(key);if(this.store.has(item)){var from=this.store.get(item).value;if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,from)}this.store["delete"](item);this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};GenericMap.prototype.clear=function(){var keys;if(this.dispatchesMapChanges){this.forEach(function(value,key){this.dispatchBeforeMapChange(key,value)},this);keys=this.keys()}this.store.clear();this.length=0;if(this.dispatchesMapChanges){keys.forEach(function(key){this.dispatchMapChange(key)},this)}};GenericMap.prototype.reduce=function(callback,basis,thisp){return this.store.reduce(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.reduceRight=function(callback,basis,thisp){return this.store.reduceRight(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.keys=function(){return this.map(function(value,key){return key})};GenericMap.prototype.values=function(){return this.map(Function.identity)};GenericMap.prototype.entries=function(){return this.map(function(value,key){return[key,value]})};GenericMap.prototype.items=function(){return this.entries()};GenericMap.prototype.equals=function(that,equals){equals=equals||Object.equals;if(this===that){return true}else if(that&&typeof that.every==="function"){return that.length===this.length&&that.every(function(value,key){return equals(this.get(key),value)},this)}else{var keys=Object.keys(that);return keys.length===this.length&&Object.keys(that).every(function(key){return equals(this.get(key),that[key])},this)}};GenericMap.prototype.Item=Item;function Item(key,value){this.key=key;this.value=value}Item.prototype.equals=function(that){return Object.equals(this.key,that.key)&&Object.equals(this.value,that.value)};Item.prototype.compare=function(that){return Object.compare(this.key,that.key)}},{"./listen/map-changes":25,"./listen/property-changes":26,"./shim-object":31}],22:[function(require,module,exports){var Object=require("./shim-object");module.exports=GenericOrder;function GenericOrder(){throw new Error("Can't construct. GenericOrder is a mixin.")}GenericOrder.prototype.equals=function(that,equals){equals=equals||this.contentEquals||Object.equals;if(this===that){return true}if(!that){return false}var self=this;return this.length===that.length&&this.zip(that).every(function(pair){return equals(pair[0],pair[1])})};GenericOrder.prototype.compare=function(that,compare){compare=compare||this.contentCompare||Object.compare;if(this===that){return 0}if(!that){return 1}var length=Math.min(this.length,that.length);var comparison=this.zip(that).reduce(function(comparison,pair,index){if(comparison===0){if(index>=length){return comparison}else{return compare(pair[0],pair[1])}}else{return comparison}},0);if(comparison===0){return this.length-that.length}return comparison}},{"./shim-object":31}],23:[function(require,module,exports){module.exports=GenericSet;function GenericSet(){throw new Error("Can't construct. GenericSet is a mixin.")}GenericSet.prototype.isSet=true;GenericSet.prototype.union=function(that){var union=this.constructClone(this);union.addEach(that);return union};GenericSet.prototype.intersection=function(that){return this.constructClone(this.filter(function(value){return that.has(value)}))};GenericSet.prototype.difference=function(that){var union=this.constructClone(this);union.deleteEach(that);return union};GenericSet.prototype.symmetricDifference=function(that){var union=this.union(that);var intersection=this.intersection(that);return union.difference(intersection)};GenericSet.prototype.equals=function(that,equals){var self=this;return that&&typeof that.reduce==="function"&&this.length===that.length&&that.reduce(function(equal,value){return equal&&self.has(value,equals)},true)};GenericSet.prototype.contains=function(value){return this.has(value)};GenericSet.prototype.remove=function(value){return this["delete"](value)};GenericSet.prototype.toggle=function(value){if(this.has(value)){this["delete"](value)}else{this.add(value)}}},{}],24:[function(require,module,exports){"use strict";module.exports=List;var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var PropertyChanges=require("./listen/property-changes");var RangeChanges=require("./listen/range-changes");function List(values,equals,getDefault){if(!(this instanceof List)){return new List(values,equals,getDefault)}var head=this.head=new this.Node;head.next=head;head.prev=head;this.contentEquals=equals||Object.equals;this.getDefault=getDefault||Function.noop;this.length=0;this.addEach(values)}List.List=List;Object.addEach(List.prototype,GenericCollection.prototype);Object.addEach(List.prototype,GenericOrder.prototype);Object.addEach(List.prototype,PropertyChanges.prototype);Object.addEach(List.prototype,RangeChanges.prototype);List.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.getDefault)};List.prototype.find=function(value,equals,index){equals=equals||this.contentEquals;var head=this.head;var at=this.scan(index,head.next);while(at!==head){if(equals(at.value,value)){return at}at=at.next}};List.prototype.findLast=function(value,equals,index){equals=equals||this.contentEquals;var head=this.head;var at=this.scan(index,head.prev);while(at!==head){if(equals(at.value,value)){return at}at=at.prev}};List.prototype.has=function(value,equals){return!!this.find(value,equals)};List.prototype.get=function(value,equals){var found=this.find(value,equals);if(found){return found.value}return this.getDefault(value)};List.prototype["delete"]=function(value,equals){var found=this.findLast(value,equals);if(found){if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,found.index)}found["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(found.next,found.index);this.dispatchRangeChange(plus,minus,found.index)}return true}return false};List.prototype.clear=function(){var plus,minus;if(this.dispatchesRangeChanges){minus=this.toArray();plus=[];this.dispatchBeforeRangeChange(plus,minus,0)}this.head.next=this.head.prev=this.head;this.length=0;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}};List.prototype.add=function(value){var node=new this.Node(value);if(this.dispatchesRangeChanges){node.index=this.length;this.dispatchBeforeRangeChange([value],[],node.index)}this.head.addBefore(node);this.length++;if(this.dispatchesRangeChanges){this.dispatchRangeChange([value],[],node.index)}return true};List.prototype.push=function(){var head=this.head;if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];var index=this.length;this.dispatchBeforeRangeChange(plus,minus,index);var start=this.head.prev}for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);head.addBefore(node)}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(start.next,start.index===undefined?0:start.index+1);this.dispatchRangeChange(plus,minus,index)}};List.prototype.unshift=function(){if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);at.addAfter(node);at=node}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}};List.prototype.pop=function(){var value;var head=this.head;if(head.prev!==head){value=head.prev.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];var index=this.length-1;this.dispatchBeforeRangeChange(plus,minus,index)}head.prev["delete"]();this.length--;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,index)}}return value};List.prototype.shift=function(){var value;var head=this.head;if(head.prev!==head){value=head.next.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,0)}head.next["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}}return value};List.prototype.peek=function(){if(this.head!==this.head.next){return this.head.next.value}};List.prototype.poke=function(value){if(this.head!==this.head.next){this.head.next.value=value}else{this.push(value)}};List.prototype.one=function(){return this.peek()};List.prototype.scan=function(at,fallback){var head=this.head;if(typeof at==="number"){var count=at;if(count>=0){at=head.next;while(count){count--;at=at.next;if(at==head){break}}}else{at=head;while(count<0){count++;at=at.prev;if(at==head){break}}}return at}else{return at||fallback}};List.prototype.slice=function(at,end){var sliced=[];var head=this.head;at=this.scan(at,head.next);end=this.scan(end,head);while(at!==end&&at!==head){sliced.push(at.value);at=at.next}return sliced};List.prototype.splice=function(at,length){return this.swap(at,length,Array.prototype.slice.call(arguments,2))
};List.prototype.swap=function(start,length,plus){var initial=start;start=this.scan(start,this.head);if(length==null){length=Infinity}plus=Array.from(plus);var minus=[];var at=start;while(length--&&length>=0&&at!==this.head){minus.push(at.value);at=at.next}var index,startNode;if(this.dispatchesRangeChanges){if(start===this.head){index=this.length}else if(start.prev===this.head){index=0}else{index=start.index}startNode=start.prev;this.dispatchBeforeRangeChange(plus,minus,index)}var at=start;for(var i=0,at=start;i<minus.length;i++,at=at.next){at["delete"]()}if(initial==null&&at===this.head){at=this.head.next}for(var i=0;i<plus.length;i++){var node=new this.Node(plus[i]);at.addBefore(node)}this.length+=plus.length-minus.length;if(this.dispatchesRangeChanges){if(start===this.head){this.updateIndexes(this.head.next,0)}else{this.updateIndexes(startNode.next,startNode.index+1)}this.dispatchRangeChange(plus,minus,index)}return minus};List.prototype.reverse=function(){if(this.dispatchesRangeChanges){var minus=this.toArray();var plus=minus.reversed();this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;do{var temp=at.next;at.next=at.prev;at.prev=temp;at=at.next}while(at!==this.head);if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}return this};List.prototype.sort=function(){this.swap(0,this.length,this.sorted())};List.prototype.reduce=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.next;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.next}return basis};List.prototype.reduceRight=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.prev;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.prev}return basis};List.prototype.updateIndexes=function(node,index){while(node!==this.head){node.index=index++;node=node.next}};List.prototype.makeObservable=function(){this.head.index=-1;this.updateIndexes(this.head.next,0);this.dispatchesRangeChanges=true};List.prototype.iterate=function(){return new ListIterator(this.head)};function ListIterator(head){this.head=head;this.at=head.next}ListIterator.prototype.next=function(){if(this.at===this.head){throw StopIteration}else{var value=this.at.value;this.at=this.at.next;return value}};List.prototype.Node=Node;function Node(value){this.value=value;this.prev=null;this.next=null}Node.prototype["delete"]=function(){this.prev.next=this.next;this.next.prev=this.prev};Node.prototype.addBefore=function(node){var prev=this.prev;this.prev=node;node.prev=prev;prev.next=node;node.next=this};Node.prototype.addAfter=function(node){var next=this.next;this.next=node;node.next=next;next.prev=node;node.prev=this}},{"./generic-collection":20,"./generic-order":22,"./listen/property-changes":26,"./listen/range-changes":27,"./shim":33}],25:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var List=require("../list");module.exports=MapChanges;function MapChanges(){throw new Error("Can't construct. MapChanges is a mixin.")}var object_owns=Object.prototype.hasOwnProperty;var mapChangeDescriptors=new WeakMap;MapChanges.prototype.getAllMapChangeDescriptors=function(){var Dict=require("../dict");if(!mapChangeDescriptors.has(this)){mapChangeDescriptors.set(this,Dict())}return mapChangeDescriptors.get(this)};MapChanges.prototype.getMapChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllMapChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{willChangeListeners:new List,changeListeners:new List})}return tokenChangeDescriptors.get(token)};MapChanges.prototype.addMapChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesMapChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelMapChangeListener(){if(!self){return}self.removeMapChangeListener(listener,token,beforeChange);self=null}};MapChanges.prototype.removeMapChangeListener=function(listener,token,beforeChange){var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var node=listeners.findLast(listener);if(!node){throw new Error("Can't remove map change listener: does not exist: token "+JSON.stringify(token))}node["delete"]()};MapChanges.prototype.dispatchMapChange=function(key,value,beforeChange){var descriptors=this.getAllMapChangeDescriptors();var changeName="Map"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.forEach(function(listener){if(listener[tokenName]){listener[tokenName](value,key,this)}else if(listener.call){listener.call(listener,value,key,this)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};MapChanges.prototype.addBeforeMapChangeListener=function(listener,token){return this.addMapChangeListener(listener,token,true)};MapChanges.prototype.removeBeforeMapChangeListener=function(listener,token){return this.removeMapChangeListener(listener,token,true)};MapChanges.prototype.dispatchBeforeMapChange=function(key,value){return this.dispatchMapChange(key,value,true)}},{"../dict":17,"../list":24,"weak-map":28}],26:[function(require,module,exports){require("../shim");var WeakMap=require("weak-map");var object_owns=Object.prototype.hasOwnProperty;var propertyChangeDescriptors=new WeakMap;var overriddenObjectDescriptors=new WeakMap;module.exports=PropertyChanges;function PropertyChanges(){throw new Error("This is an abstract interface. Mix it. Don't construct it")}PropertyChanges.debug=true;PropertyChanges.prototype.getOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){propertyChangeDescriptors.set(this,{})}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){objectPropertyChangeDescriptors[key]={willChangeListeners:[],changeListeners:[]}}return objectPropertyChangeDescriptors[key]};PropertyChanges.prototype.hasOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){return false}if(!key){return true}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){return false}return true};PropertyChanges.prototype.addOwnPropertyChangeListener=function(key,listener,beforeChange){if(this.makeObservable&&!this.isObservable){this.makeObservable()}var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}PropertyChanges.makePropertyObservable(this,key);listeners.push(listener);var self=this;return function cancelOwnPropertyChangeListener(){PropertyChanges.removeOwnPropertyChangeListener(self,key,listeners,beforeChange);self=null}};PropertyChanges.prototype.addBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.addOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.removeOwnPropertyChangeListener=function(key,listener,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove property change listener: does not exist: property name"+JSON.stringify(key))}listeners.splice(index,1)};PropertyChanges.prototype.removeBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.removeOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.dispatchOwnPropertyChange=function(key,value,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);if(descriptor.isActive){return}descriptor.isActive=true;var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var changeName=(beforeChange?"Will":"")+"Change";var genericHandlerName="handleProperty"+changeName;var propertyName=String(key);propertyName=propertyName&&propertyName[0].toUpperCase()+propertyName.slice(1);var specificHandlerName="handle"+propertyName+changeName;try{listeners.slice().forEach(function(listener){if(listeners.indexOf(listener)<0){return}var thisp=listener;listener=listener[specificHandlerName]||listener[genericHandlerName]||listener;if(!listener.call){throw new Error("No event listener for "+specificHandlerName+" or "+genericHandlerName+" or call on "+listener)}listener.call(thisp,value,key,this)},this)}finally{descriptor.isActive=false}};PropertyChanges.prototype.dispatchBeforeOwnPropertyChange=function(key,listener){return PropertyChanges.dispatchOwnPropertyChange(this,key,listener,true)};PropertyChanges.prototype.makePropertyObservable=function(key){if(Array.isArray(this)){return}if(!Object.isExtensible(this,key)){throw new Error("Can't make property "+JSON.stringify(key)+" observable on "+this+" because object is not extensible")}var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}state[key]=this[key];if(!overriddenObjectDescriptors.has(this)){overriddenPropertyDescriptors={};overriddenObjectDescriptors.set(this,overriddenPropertyDescriptors)}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(object_owns.call(overriddenPropertyDescriptors,key)){return}var overriddenDescriptor;var attached=this;var formerDescriptor=Object.getOwnPropertyDescriptor(attached,key);do{overriddenDescriptor=Object.getOwnPropertyDescriptor(attached,key);if(overriddenDescriptor){break}attached=Object.getPrototypeOf(attached)}while(attached);overriddenDescriptor=overriddenDescriptor||{value:undefined,enumerable:true,writable:true,configurable:true};if(!overriddenDescriptor.configurable){throw new Error("Can't observe non-configurable properties")}overriddenPropertyDescriptors[key]=overriddenDescriptor;if(!overriddenDescriptor.writable&&!overriddenDescriptor.set){return}var propertyListener;if("value"in overriddenDescriptor){propertyListener={get:function(){return overriddenDescriptor.value},set:function(value){if(value===overriddenDescriptor.value){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,overriddenDescriptor.value);overriddenDescriptor.value=value;state[key]=value;PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}else{propertyListener={get:function(){if(overriddenDescriptor.get){return overriddenDescriptor.get.apply(this,arguments)}},set:function(value){var formerValue;if(overriddenDescriptor.get){formerValue=overriddenDescriptor.get.apply(this,arguments)}if(overriddenDescriptor.set){overriddenDescriptor.set.apply(this,arguments)}if(overriddenDescriptor.get){value=overriddenDescriptor.get.apply(this,arguments);state[key]=value}if(value===formerValue){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,formerValue);PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}Object.defineProperty(this,key,propertyListener)};PropertyChanges.prototype.makePropertyUnobservable=function(key){if(Array.isArray(this)){return}if(!overriddenObjectDescriptors.has(this)){throw new Error("Can't uninstall observer on property")}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(!overriddenPropertyDescriptors[key]){throw new Error("Can't uninstall observer on property")}var overriddenDescriptor=overriddenPropertyDescriptors[key];delete overriddenPropertyDescriptors[key];var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}delete state[key];Object.defineProperty(this,key,overriddenDescriptor)};PropertyChanges.getOwnPropertyChangeDescriptor=function(object,key){if(object.getOwnPropertyChangeDescriptor){return object.getOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.getOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.hasOwnPropertyChangeDescriptor=function(object,key){if(object.hasOwnPropertyChangeDescriptor){return object.hasOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.hasOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.addOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.addOwnPropertyChangeListener){return object.addOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.addOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.removeOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.removeOwnPropertyChangeListener){return object.removeOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.removeOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.dispatchOwnPropertyChange=function(object,key,value,beforeChange){if(!Object.isObject(object)){}else if(object.dispatchOwnPropertyChange){return object.dispatchOwnPropertyChange(key,value,beforeChange)}else{return PropertyChanges.prototype.dispatchOwnPropertyChange.call(object,key,value,beforeChange)}};PropertyChanges.addBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.addOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.removeBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.removeOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.dispatchBeforeOwnPropertyChange=function(object,key,value){return PropertyChanges.dispatchOwnPropertyChange(object,key,value,true)};PropertyChanges.makePropertyObservable=function(object,key){if(object.makePropertyObservable){return object.makePropertyObservable(key)}else{return PropertyChanges.prototype.makePropertyObservable.call(object,key)}};PropertyChanges.makePropertyUnobservable=function(object,key){if(object.makePropertyUnobservable){return object.makePropertyUnobservable(key)}else{return PropertyChanges.prototype.makePropertyUnobservable.call(object,key)}}},{"../shim":33,"weak-map":28}],27:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var Dict=require("../dict");var rangeChangeDescriptors=new WeakMap;module.exports=RangeChanges;function RangeChanges(){throw new Error("Can't construct. RangeChanges is a mixin.")}RangeChanges.prototype.getAllRangeChangeDescriptors=function(){if(!rangeChangeDescriptors.has(this)){rangeChangeDescriptors.set(this,Dict())}return rangeChangeDescriptors.get(this)};RangeChanges.prototype.getRangeChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllRangeChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{isActive:false,changeListeners:[],willChangeListeners:[]})}return tokenChangeDescriptors.get(token)};RangeChanges.prototype.addRangeChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesRangeChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelRangeChangeListener(){if(!self){return}self.removeRangeChangeListener(listener,token,beforeChange);self=null}};RangeChanges.prototype.removeRangeChangeListener=function(listener,token,beforeChange){var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove range change listener: does not exist: token "+JSON.stringify(token))}listeners.splice(index,1)};RangeChanges.prototype.dispatchRangeChange=function(plus,minus,index,beforeChange){var descriptors=this.getAllRangeChangeDescriptors();var changeName="Range"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.slice().forEach(function(listener){if(listeners.indexOf(listener)<0){return}if(listener[tokenName]){listener[tokenName](plus,minus,index,this,beforeChange)}else if(listener.call){listener.call(this,plus,minus,index,this,beforeChange)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};RangeChanges.prototype.addBeforeRangeChangeListener=function(listener,token){return this.addRangeChangeListener(listener,token,true)};RangeChanges.prototype.removeBeforeRangeChangeListener=function(listener,token){return this.removeRangeChangeListener(listener,token,true)};RangeChanges.prototype.dispatchBeforeRangeChange=function(plus,minus,index){return this.dispatchRangeChange(plus,minus,index,true)}},{"../dict":17,"weak-map":28}],28:[function(require,module,exports){(function WeakMapModule(){"use strict";if(typeof ses!=="undefined"&&ses.ok&&!ses.ok()){return}function weakMapPermitHostObjects(map){if(map.permitHostObjects___){map.permitHostObjects___(weakMapPermitHostObjects)}}if(typeof ses!=="undefined"){ses.weakMapPermitHostObjects=weakMapPermitHostObjects}if(typeof WeakMap==="function"){var HostWeakMap=WeakMap;if(typeof navigator!=="undefined"&&/Firefox/.test(navigator.userAgent)){}else{module.exports=WeakMap;return}}var hop=Object.prototype.hasOwnProperty;var gopn=Object.getOwnPropertyNames;var defProp=Object.defineProperty;var isExtensible=Object.isExtensible;var HIDDEN_NAME_PREFIX="weakmap:";var HIDDEN_NAME=HIDDEN_NAME_PREFIX+"ident:"+Math.random()+"___";if(typeof crypto!=="undefined"&&typeof crypto.getRandomValues==="function"&&typeof ArrayBuffer==="function"&&typeof Uint8Array==="function"){var ab=new ArrayBuffer(25);var u8s=new Uint8Array(ab);crypto.getRandomValues(u8s);HIDDEN_NAME=HIDDEN_NAME_PREFIX+"rand:"+Array.prototype.map.call(u8s,function(u8){return(u8%36).toString(36)}).join("")+"___"}function isNotHiddenName(name){return!(name.substr(0,HIDDEN_NAME_PREFIX.length)==HIDDEN_NAME_PREFIX&&name.substr(name.length-3)==="___")}defProp(Object,"getOwnPropertyNames",{value:function fakeGetOwnPropertyNames(obj){return gopn(obj).filter(isNotHiddenName)}});if("getPropertyNames"in Object){var originalGetPropertyNames=Object.getPropertyNames;defProp(Object,"getPropertyNames",{value:function fakeGetPropertyNames(obj){return originalGetPropertyNames(obj).filter(isNotHiddenName)}})}function getHiddenRecord(key){if(key!==Object(key)){throw new TypeError("Not an object: "+key)}var hiddenRecord=key[HIDDEN_NAME];if(hiddenRecord&&hiddenRecord.key===key){return hiddenRecord}if(!isExtensible(key)){return void 0}var gets=[];var vals=[];hiddenRecord={key:key,gets:gets,vals:vals};defProp(key,HIDDEN_NAME,{value:hiddenRecord,writable:false,enumerable:false,configurable:false});return hiddenRecord}(function(){var oldFreeze=Object.freeze;defProp(Object,"freeze",{value:function identifyingFreeze(obj){getHiddenRecord(obj);return oldFreeze(obj)}});var oldSeal=Object.seal;defProp(Object,"seal",{value:function identifyingSeal(obj){getHiddenRecord(obj);return oldSeal(obj)}});var oldPreventExtensions=Object.preventExtensions;defProp(Object,"preventExtensions",{value:function identifyingPreventExtensions(obj){getHiddenRecord(obj);return oldPreventExtensions(obj)}})})();function constFunc(func){func.prototype=null;return Object.freeze(func)}var OurWeakMap=function(){var keys=[];var vals=[];function get___(key,opt_default){var hr=getHiddenRecord(key);var i,vs;if(hr){i=hr.gets.indexOf(get___);vs=hr.vals}else{i=keys.indexOf(key);vs=vals}return i>=0?vs[i]:opt_default}function has___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___)}else{i=keys.indexOf(key)}return i>=0}function set___(key,value){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.vals[i]=value}else{hr.gets.push(get___);hr.vals.push(value)}}else{i=keys.indexOf(key);if(i>=0){vals[i]=value}else{keys.push(key);vals.push(value)}}}function delete___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.gets.splice(i,1);hr.vals.splice(i,1)}}else{i=keys.indexOf(key);if(i>=0){keys.splice(i,1);vals.splice(i,1)}}return true}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(get___)},has___:{value:constFunc(has___)},set___:{value:constFunc(set___)},delete___:{value:constFunc(delete___)}})};OurWeakMap.prototype=Object.create(Object.prototype,{get:{value:function get(key,opt_default){return this.get___(key,opt_default)},writable:true,configurable:true},has:{value:function has(key){return this.has___(key)},writable:true,configurable:true},set:{value:function set(key,value){this.set___(key,value)},writable:true,configurable:true},"delete":{value:function remove(key){return this.delete___(key)},writable:true,configurable:true}});if(typeof HostWeakMap==="function"){(function(){function DoubleWeakMap(){var hmap=new HostWeakMap;var omap=undefined;var enableSwitching=false;function dget(key,opt_default){if(omap){return hmap.has(key)?hmap.get(key):omap.get___(key,opt_default)}else{return hmap.get(key,opt_default)}}function dhas(key){return hmap.has(key)||(omap?omap.has___(key):false)}function dset(key,value){if(enableSwitching){try{hmap.set(key,value)}catch(e){if(!omap){omap=new OurWeakMap}omap.set___(key,value)}}else{hmap.set(key,value)}}function ddelete(key){hmap["delete"](key);if(omap){omap.delete___(key)}}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(dget)},has___:{value:constFunc(dhas)},set___:{value:constFunc(dset)},delete___:{value:constFunc(ddelete)},permitHostObjects___:{value:constFunc(function(token){if(token===weakMapPermitHostObjects){enableSwitching=true}else{throw new Error("bogus call to permitHostObjects___")}})}})}DoubleWeakMap.prototype=OurWeakMap.prototype;module.exports=DoubleWeakMap;Object.defineProperty(WeakMap.prototype,"constructor",{value:WeakMap,enumerable:false,configurable:true,writable:true})})()}else{if(typeof Proxy!=="undefined"){Proxy=undefined}module.exports=OurWeakMap}})()},{}],29:[function(require,module,exports){"use strict";var Function=require("./shim-function");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var WeakMap=require("weak-map");module.exports=Array;var array_splice=Array.prototype.splice;var array_slice=Array.prototype.slice;Array.empty=[];if(Object.freeze){Object.freeze(Array.empty)}Array.from=function(values){var array=[];array.addEach(values);return array};Array.unzip=function(table){var transpose=[];var length=Infinity;for(var i=0;i<table.length;i++){var row=table[i];table[i]=row.toArray();if(row.length<length){length=row.length}}for(var i=0;i<table.length;i++){var row=table[i];for(var j=0;j<row.length;j++){if(j<length&&j in row){transpose[j]=transpose[j]||[];transpose[j][i]=row[j]}}}return transpose};function define(key,value){Object.defineProperty(Array.prototype,key,{value:value,writable:true,configurable:true,enumerable:false})}define("addEach",GenericCollection.prototype.addEach);define("deleteEach",GenericCollection.prototype.deleteEach);define("toArray",GenericCollection.prototype.toArray);define("toObject",GenericCollection.prototype.toObject);define("all",GenericCollection.prototype.all);define("any",GenericCollection.prototype.any);define("min",GenericCollection.prototype.min);define("max",GenericCollection.prototype.max);define("sum",GenericCollection.prototype.sum);define("average",GenericCollection.prototype.average);define("only",GenericCollection.prototype.only);define("flatten",GenericCollection.prototype.flatten);define("zip",GenericCollection.prototype.zip);define("enumerate",GenericCollection.prototype.enumerate);define("group",GenericCollection.prototype.group);define("sorted",GenericCollection.prototype.sorted);define("reversed",GenericCollection.prototype.reversed);define("constructClone",function(values){var clone=new this.constructor;clone.addEach(values);return clone});define("has",function(value,equals){return this.find(value,equals)!==-1});define("get",function(index,defaultValue){if(+index!==index)throw new Error("Indicies must be numbers");if(!index in this){return defaultValue}else{return this[index]}});define("set",function(index,value){this[index]=value;return true});define("add",function(value){this.push(value);return true});define("delete",function(value,equals){var index=this.find(value,equals);if(index!==-1){this.splice(index,1);return true}return false});define("find",function(value,equals){equals=equals||this.contentEquals||Object.equals;for(var index=0;index<this.length;index++){if(index in this&&equals(this[index],value)){return index}}return-1});define("findLast",function(value,equals){equals=equals||this.contentEquals||Object.equals;var index=this.length;do{index--;if(index in this&&equals(this[index],value)){return index}}while(index>0);return-1});define("swap",function(start,length,plus){var args,plusLength,i,j,returnValue;if(start>this.length){this.length=start}if(typeof plus!=="undefined"){args=[start,length];if(!Array.isArray(plus)){plus=array_slice.call(plus)}i=0;plusLength=plus.length;if(plusLength<1e3){for(i;i<plusLength;i++){args[i+2]=plus[i]}return array_splice.apply(this,args)}else{returnValue=array_splice.apply(this,args);for(i;i<plusLength;){args=[start+i,0];for(j=2;j<1002&&i<plusLength;j++,i++){args[j]=plus[i]}array_splice.apply(this,args)}return returnValue}}else if(typeof length!=="undefined"){return array_splice.call(this,start,length)}else if(typeof start!=="undefined"){return array_splice.call(this,start)}else{return[]}});define("peek",function(){return this[0]});define("poke",function(value){if(this.length>0){this[0]=value}});define("peekBack",function(){if(this.length>0){return this[this.length-1]}});define("pokeBack",function(value){if(this.length>0){this[this.length-1]=value}});define("one",function(){for(var i in this){if(Object.owns(this,i)){return this[i]}}});define("clear",function(){this.length=0;return this});define("compare",function(that,compare){compare=compare||Object.compare;var i;var length;var lhs;var rhs;var relative;if(this===that){return 0}if(!that||!Array.isArray(that)){return GenericOrder.prototype.compare.call(this,that,compare)}length=Math.min(this.length,that.length);for(i=0;i<length;i++){if(i in this){if(!(i in that)){return-1}else{lhs=this[i];rhs=that[i];relative=compare(lhs,rhs);if(relative){return relative}}}else if(i in that){return 1}}return this.length-that.length});define("equals",function(that,equals){equals=equals||Object.equals;var i=0;var length=this.length;var left;var right;if(this===that){return true}if(!that||!Array.isArray(that)){return GenericOrder.prototype.equals.call(this,that)}if(length!==that.length){return false}else{for(;i<length;++i){if(i in this){if(!(i in that)){return false}left=this[i];right=that[i];if(!equals(left,right)){return false}}else{if(i in that){return false}}}}return true});define("clone",function(depth,memo){if(depth==null){depth=Infinity}else if(depth===0){return this}memo=memo||new WeakMap;if(memo.has(this)){return memo.get(this)}var clone=new Array(this.length);memo.set(this,clone);for(var i in this){clone[i]=Object.clone(this[i],depth-1,memo)}return clone});define("iterate",function(start,end){return new ArrayIterator(this,start,end)});define("Iterator",ArrayIterator);function ArrayIterator(array,start,end){this.array=array;this.start=start==null?0:start;this.end=end}ArrayIterator.prototype.next=function(){if(this.start===(this.end==null?this.array.length:this.end)){throw StopIteration}else{return this.array[this.start++]}}},{"./generic-collection":20,"./generic-order":22,"./shim-function":30,"weak-map":28}],30:[function(require,module,exports){module.exports=Function;Function.noop=function(){};Function.identity=function(value){return value};Function.by=function(by,compare){compare=compare||Object.compare;by=by||Function.identity;var compareBy=function(a,b){return compare(by(a),by(b))};compareBy.compare=compare;compareBy.by=by;return compareBy};Function.get=function(key){return function(object){return Object.get(object,key)}}},{}],31:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");module.exports=Object;Object.empty=Object.freeze(Object.create(null));Object.isObject=function(object){return Object(object)===object};Object.getValueOf=function(value){if(value&&typeof value.valueOf==="function"){value=value.valueOf()}return value};var hashMap=new WeakMap;Object.hash=function(object){if(object&&typeof object.hash==="function"){return""+object.hash()}else if(Object(object)===object){if(!hashMap.has(object)){hashMap.set(object,Math.random().toString(36).slice(2))}return hashMap.get(object)}else{return""+object}};var owns=Object.prototype.hasOwnProperty;Object.owns=function(object,key){return owns.call(object,key)};Object.has=function(object,key){if(typeof object!=="object"){throw new Error("Object.has can't accept non-object: "+typeof object)}if(object&&typeof object.has==="function"){return object.has(key)}else if(typeof key==="string"){return key in object&&object[key]!==Object.prototype[key]}else{throw new Error("Key must be a string for Object.has on plain objects")}};Object.get=function(object,key,value){if(typeof object!=="object"){throw new Error("Object.get can't accept non-object: "+typeof object)}if(object&&typeof object.get==="function"){return object.get(key,value)}else if(Object.has(object,key)){return object[key]}else{return value}};Object.set=function(object,key,value){if(object&&typeof object.set==="function"){object.set(key,value)}else{object[key]=value}};Object.addEach=function(target,source){if(!source){}else if(typeof source.forEach==="function"&&!source.hasOwnProperty("forEach")){if(typeof source.keys==="function"){source.forEach(function(value,key){target[key]=value})}else{source.forEach(function(pair){target[pair[0]]=pair[1]})}}else{Object.keys(source).forEach(function(key){target[key]=source[key]})}return target};Object.forEach=function(object,callback,thisp){Object.keys(object).forEach(function(key){callback.call(thisp,object[key],key,object)})};Object.map=function(object,callback,thisp){return Object.keys(object).map(function(key){return callback.call(thisp,object[key],key,object)})};Object.values=function(object){return Object.map(object,Function.identity)};Object.concat=function(){var object={};for(var i=0;i<arguments.length;i++){Object.addEach(object,arguments[i])}return object};Object.from=Object.concat;Object.is=function(x,y){if(x===y){return x!==0||1/x===1/y
}return x!==x&&y!==y};Object.equals=function(a,b,equals,memo){equals=equals||Object.equals;a=Object.getValueOf(a);b=Object.getValueOf(b);if(a===b)return true;if(Object.isObject(a)){memo=memo||new WeakMap;if(memo.has(a)){return true}memo.set(a,true)}if(Object.isObject(a)&&typeof a.equals==="function"){return a.equals(b,equals,memo)}if(Object.isObject(b)&&typeof b.equals==="function"){return b.equals(a,equals,memo)}if(Object.isObject(a)&&Object.isObject(b)){if(Object.getPrototypeOf(a)===Object.prototype&&Object.getPrototypeOf(b)===Object.prototype){for(var name in a){if(!equals(a[name],b[name],equals,memo)){return false}}for(var name in b){if(!(name in a)||!equals(b[name],a[name],equals,memo)){return false}}return true}}if(a!==a&&b!==b)return true;if(!a||!b)return a===b;return false};Object.compare=function(a,b){a=Object.getValueOf(a);b=Object.getValueOf(b);if(a===b)return 0;var aType=typeof a;var bType=typeof b;if(aType==="number"&&bType==="number")return a-b;if(aType==="string"&&bType==="string")return a<b?-Infinity:Infinity;if(a&&typeof a.compare==="function")return a.compare(b);if(b&&typeof b.compare==="function")return-b.compare(a);return 0};Object.clone=function(value,depth,memo){value=Object.getValueOf(value);memo=memo||new WeakMap;if(depth===undefined){depth=Infinity}else if(depth===0){return value}if(Object.isObject(value)){if(!memo.has(value)){if(value&&typeof value.clone==="function"){memo.set(value,value.clone(depth,memo))}else{var prototype=Object.getPrototypeOf(value);if(prototype===null||prototype===Object.prototype){var clone=Object.create(prototype);memo.set(value,clone);for(var key in value){clone[key]=Object.clone(value[key],depth-1,memo)}}else{throw new Error("Can't clone "+value)}}}return memo.get(value)}return value};Object.clear=function(object){if(object&&typeof object.clear==="function"){object.clear()}else{var keys=Object.keys(object),i=keys.length;while(i){i--;delete object[keys[i]]}}return object}},{"weak-map":28}],32:[function(require,module,exports){if(!RegExp.escape){var special=/[-[\]{}()*+?.\\^$|,#\s]/g;RegExp.escape=function(string){return string.replace(special,"\\$&")}}},{}],33:[function(require,module,exports){var Array=require("./shim-array");var Object=require("./shim-object");var Function=require("./shim-function");var RegExp=require("./shim-regexp")},{"./shim-array":29,"./shim-function":30,"./shim-object":31,"./shim-regexp":32}],34:[function(require,module,exports){"use strict";module.exports=TreeLog;function TreeLog(){}TreeLog.ascii={intersection:"+",through:"-",branchUp:"+",branchDown:"+",fromBelow:".",fromAbove:"'",fromBoth:"+",strafe:"|"};TreeLog.unicodeRound={intersection:"╋",through:"━",branchUp:"┻",branchDown:"┳",fromBelow:"╭",fromAbove:"╰",fromBoth:"┣",strafe:"┃"};TreeLog.unicodeSharp={intersection:"╋",through:"━",branchUp:"┻",branchDown:"┳",fromBelow:"┏",fromAbove:"┗",fromBoth:"┣",strafe:"┃"}},{}],35:[function(require,module,exports){(function(root,factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{root.crel=factory()}})(this,function(){var isNode=typeof Node==="function"?function(object){return object instanceof Node}:function(object){return object&&typeof object==="object"&&typeof object.nodeType==="number"&&typeof object.nodeName==="string"};var isArray=function(a){return a instanceof Array};var appendChild=function(element,child){if(!isNode(child)){child=document.createTextNode(child)}element.appendChild(child)};function crel(){var document=window.document,args=arguments,element=args[0],child,settings=args[1],childIndex=2,argumentsLength=args.length,attributeMap=crel.attrMap;element=isNode(element)?element:document.createElement(element);if(argumentsLength===1){return element}if(typeof settings!=="object"||isNode(settings)||isArray(settings)){--childIndex;settings=null}if(argumentsLength-childIndex===1&&typeof args[childIndex]==="string"&&element.textContent!==undefined){element.textContent=args[childIndex]}else{for(;childIndex<argumentsLength;++childIndex){child=args[childIndex];if(child==null){continue}if(isArray(child)){for(var i=0;i<child.length;++i){appendChild(element,child[i])}}else{appendChild(element,child)}}}for(var key in settings){if(!attributeMap[key]){element.setAttribute(key,settings[key])}else{var attr=crel.attrMap[key];if(typeof attr==="function"){attr(element,settings[key])}else{element.setAttribute(attr,settings[key])}}}return element}crel["attrMap"]={};crel["isNode"]=isNode;return crel})},{}],36:[function(require,module,exports){"use strict";var reSeparator=/[\,\s]\s*/;var offFlags=["false","none","off"];module.exports=function(input){var config=new CaptureConfig;(input||"").split(reSeparator).forEach(function(directive){var parts=directive.split(":");var method=config[(parts[0]||"").toLowerCase()];if(typeof method=="function"){method.apply(config,parts.slice(1))}});return config};function CaptureConfig(){if(!(this instanceof CaptureConfig)){return new CaptureConfig}this.cfg={microphone:true}}var prot=CaptureConfig.prototype;prot.camera=function(index){this.cfg.camera=trueOrValue(index)};prot.microphone=function(index){this.cfg.microphone=trueOrValue(index)};prot.screen=function(){delete this.cfg.microphone;this.cfg.screen=true};prot.max=function(data){var res;if(data.slice(-3).toLowerCase()=="fps"){return this.maxfps(data)}res=this._parseRes(data);this.cfg.res=this.cfg.res||{};this.cfg.res.max=res};prot.maxfps=function(data){this.cfg.fps=this.cfg.fps||{};this.cfg.fps.max=parseFloat(data.slice(0,-3))};prot.min=function(data){var res;if(data.slice(-3).toLowerCase()=="fps"){return this.minfps(data)}res=this._parseRes(data);this.cfg.res=this.cfg.res||{};this.cfg.res.min=res};prot.minfps=function(data){this.cfg.fps=this.cfg.fps||{};this.cfg.fps.min=parseFloat(data.slice(0,-3))};prot.hd=prot["720p"]=function(){this.cfg.camera=true;this.min("1280x720")};prot.fullhd=prot["1080p"]=function(){this.cfg.camera=true;this.min("1920x1080")};prot.toConstraints=function(opts){var cfg=this.cfg;var constraints={audio:cfg.microphone===true||typeof cfg.microphone=="number"&&cfg.microphone>=0,video:cfg.camera===true||cfg.screen||typeof cfg.camera=="number"&&cfg.camera>=0};var m={video:{},audio:{}};var o={video:[],audio:[]};var sources=(opts||{}).sources||[];var cameras=sources.filter(function(info){return info&&info.kind==="video"});var microphones=sources.filter(function(info){return info&&info.kind==="audio"});var selectedSource;function complexConstraints(target){if(constraints[target]&&typeof constraints[target]!="object"){constraints[target]={mandatory:m[target],optional:o[target]}}}if(cfg.fps){complexConstraints("video");cfg.fps.min&&(m.video.minFrameRate=cfg.fps.min);cfg.fps.max&&(m.video.maxFrameRate=cfg.fps.max)}if(cfg.res&&cfg.res.min){complexConstraints("video");m.video.minWidth=cfg.res.min.w;m.video.minHeight=cfg.res.min.h}if(cfg.res&&cfg.res.max){complexConstraints("video");m.video.maxWidth=cfg.res.max.w;m.video.maxHeight=cfg.res.max.h}if(typeof cfg.camera=="number"&&cameras.length){selectedSource=cameras[cfg.camera];if(selectedSource){complexConstraints("video");o.video.push({sourceId:selectedSource.id})}}if(typeof cfg.microphone=="number"&&microphones.length){selectedSource=microphones[cfg.microphone];if(selectedSource){complexConstraints("audio");o.audio.push({sourceId:selectedSource.id})}}if(typeof cfg.screen!="undefined"){complexConstraints("video");m.video.chromeMediaSource="screen"}return constraints};prot._parseRes=function(data){var parts=data.split("x");if(parts.length<2){throw new Error("Invalid resolution specification: "+data)}return{w:parseInt(parts[0],10),h:parseInt(parts[1],10)}};function trueOrValue(val){if(typeof val=="string"&&offFlags.indexOf(val.toLowerCase())>=0){return false}return val===undefined||val===""||parseInt(val||0,10)}},{}],37:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-media");var extend=require("cog/extend");var detect=require("rtc-core/detect");var plugin=require("rtc-core/plugin");var EventEmitter=require("events").EventEmitter;var util=require("util");navigator.getUserMedia=navigator.getUserMedia||detect.call(navigator,"getUserMedia");window.URL=window.URL||detect("URL");window.MediaStream=detect("MediaStream");function Media(opts){var media=this;if(!(this instanceof Media)){return new Media(opts)}EventEmitter.call(this);if(opts&&MediaStream&&opts instanceof MediaStream){opts={stream:opts}}if(opts&&(opts.audio||opts.video)){opts={constraints:opts}}opts=extend({},{capture:!opts||!opts.stream,muted:!opts||!opts.stream,constraints:{video:{mandatory:{},optional:[]},audio:true,fake:typeof __testlingConsole!="undefined"}},opts);this.constraints=opts.constraints;this.name=opts.name;this.stream=opts.stream||null;this.muted=typeof opts.muted=="undefined"||opts.muted;this._bindings=[];this.plugin=plugin((opts||{}).plugins);if(this.plugin){media._pinst=this.plugin.init(opts,function(err){console.log("initialization complete");if(err){return media.emit("error",err)}if(!opts.stream&&opts.capture){media.capture()}})}else if(opts.capture){setTimeout(this.capture.bind(this),0)}}util.inherits(Media,EventEmitter);module.exports=Media;Media.prototype.capture=function(constraints,callback){var media=this;var handleEnd=this.emit.bind(this,"end");if(this.stream){return}if(typeof constraints=="function"){callback=constraints;constraints=this.constraints}if(typeof callback=="function"){this.once("capture",callback.bind(this))}if(typeof navigator.getUserMedia!="function"){return callback&&callback(new Error("Unable to capture user media"))}debug("getUserMedia, constraints: ",constraints||this.constraints);navigator.getUserMedia(constraints||this.constraints,function(stream){debug("sucessfully captured media stream: ",stream);if(typeof stream.addEventListener=="function"){stream.addEventListener("ended",handleEnd)}else{stream.onended=handleEnd}media.stream=stream;setTimeout(function(){media.emit("capture",stream)},0)},function(err){debug("getUserMedia attempt failed: ",err);media.emit("error",err)})};Media.prototype.render=function(target,opts,callback){if(Array.isArray(target)){console.log("WARNING: rtc-media render (as of 1.x) expects a single target");target=target[0]}if(typeof opts=="function"){callback=opts;opts={}}opts=opts||{};target=this._prepareElement(opts,target);console.log("attempting render, stream: ",this.stream);if(!this.stream){this.once("capture",this._bindStream.bind(this))}else{this._bindStream(this.stream)}if(typeof callback=="function"){this.once("render",callback)}return target};Media.prototype.stop=function(opts){var media=this;if(!this.stream){return}this._unbind(opts);this.stream.stop();this.once("capture",media._bindStream.bind(media));this.stream=null};Media.prototype._createBinding=function(opts,element){this._bindings.push({el:element,opts:opts});return element};Media.prototype._prepareElement=function(opts,element){var parent;var validElement=element instanceof HTMLVideoElement||element instanceof HTMLAudioElement;var preserveAspectRatio=typeof opts.preserveAspectRatio=="undefined"||opts.preserveAspectRatio;if(!element){throw new Error("Cannot render media to a null element")}if(this.plugin&&typeof this.plugin.prepareElement=="function"){return this._createBinding(opts,this.plugin.prepareElement.call(this._pinst,opts,element))}validElement=validElement||typeof element.play=="function"&&(typeof element.srcObject!="undefined"||typeof element.mozSrcObject!="undefined"||typeof element.src!="undefined");if(!validElement){parent=element;element=document.createElement("video");if(preserveAspectRatio){element.setAttribute("preserveAspectRatio","")}parent.appendChild(element);element.setAttribute("data-playing",false)}if(element&&this.muted){element.muted=true;element.setAttribute("muted","")}return this._createBinding(opts,element)};Media.prototype._bindStream=function(stream){var media=this;var elements=[];var waiting=[];function checkWaiting(){if(waiting.length===0&&elements.length>0){media.emit("render",elements[0]);elements.map(function(el){el.setAttribute("data-playing",true)})}}function canPlay(evt){var el=evt.target||evt.srcElement;var videoIndex=elements.indexOf(el);if(videoIndex>=0){waiting.splice(videoIndex,1)}el.play();el.removeEventListener("canplay",canPlay);el.removeEventListener("loadedmetadata",canPlay);checkWaiting()}if(this.plugin&&typeof this.plugin.attachStream=="function"){return this.plugin.attachStream.call(this._pinst,stream,this._bindings)}elements=this._bindings.map(function(binding){if(typeof binding.el.srcObject!="undefined"){binding.el.srcObject=stream}else if(typeof binding.el.mozSrcObject!="undefined"){binding.el.mozSrcObject=stream}else{binding.el.src=media._createObjectURL(stream)||stream}binding.el.play();return binding.el});waiting=elements.filter(function(el){return el.readyState<3});waiting.forEach(function(el){el.addEventListener("canplay",canPlay,false);el.addEventListener("loadedmetadata",canPlay,false)});checkWaiting()};Media.prototype._unbind=function(opts){opts=opts||{};this._bindings.forEach(function(binding){var element=binding.el;element.src=null;if(element.mozSrcObject){element.mozSrcObject=null}if(element.currentSrc){element.currentSrc=null}})};Media.prototype._createObjectURL=function(stream){try{return window.URL.createObjectURL(stream)}catch(e){}};Media.prototype._handleSuccess=function(stream){this.stream=stream;this.emit("stream",stream)}},{"cog/extend":13,"cog/logger":15,events:2,"rtc-core/detect":38,"rtc-core/plugin":40,util:11}],38:[function(require,module,exports){(function(process){"use strict";var semver=require("semver");var browsers={chrome:[/Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],firefox:[/Firefox\/([0-9\.]+)(?:\s|$)/],opera:[/Opera\/([0-9\.]+)(?:\s|$)/],ie:[/Trident\/7\.0.*rv\:([0-9\.]+)\).*Gecko$/]};var detect=module.exports=function(target,prefixes){var prefixIdx;var prefix;var testName;var hostObject=this||(typeof window!="undefined"?window:undefined);if(!hostObject){return}prefixes=(prefixes||["ms","o","moz","webkit"]).concat("");for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();return hostObject[target]=hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;if(typeof navigator!="undefined"){Object.keys(browsers).forEach(function(key){var match=browsers[key].map(function(regex){return regex.exec(navigator.userAgent)}).filter(Boolean)[0];if(match){detect.browser=key;detect.browserVersion=detect.version=parseVersion(match[1])}});detect.browser=detect.browser||"unknown"}else{detect.browser="node";detect.browserVersion=detect.version=parseVersion(process.version.substr(1))}function parseVersion(version){var versionParts=version.split(".").slice(0,3);while(versionParts.length<3){versionParts.push("0")}return semver.clean(versionParts.join("."))||version}}).call(this,require("FWaASH"))},{FWaASH:4,semver:39}],39:[function(require,module,exports){(function(exports){if(typeof module==="object"&&module.exports===exports)exports=module.exports=SemVer;exports.SEMVER_SPEC_VERSION="2.0.0";var re=exports.re=[];var src=exports.src=[];var R=0;var NUMERICIDENTIFIER=R++;src[NUMERICIDENTIFIER]="0|[1-9]\\d*";var NUMERICIDENTIFIERLOOSE=R++;src[NUMERICIDENTIFIERLOOSE]="[0-9]+";var NONNUMERICIDENTIFIER=R++;src[NONNUMERICIDENTIFIER]="\\d*[a-zA-Z-][a-zA-Z0-9-]*";var MAINVERSION=R++;src[MAINVERSION]="("+src[NUMERICIDENTIFIER]+")\\."+"("+src[NUMERICIDENTIFIER]+")\\."+"("+src[NUMERICIDENTIFIER]+")";var MAINVERSIONLOOSE=R++;src[MAINVERSIONLOOSE]="("+src[NUMERICIDENTIFIERLOOSE]+")\\."+"("+src[NUMERICIDENTIFIERLOOSE]+")\\."+"("+src[NUMERICIDENTIFIERLOOSE]+")";var PRERELEASEIDENTIFIER=R++;src[PRERELEASEIDENTIFIER]="(?:"+src[NUMERICIDENTIFIER]+"|"+src[NONNUMERICIDENTIFIER]+")";var PRERELEASEIDENTIFIERLOOSE=R++;src[PRERELEASEIDENTIFIERLOOSE]="(?:"+src[NUMERICIDENTIFIERLOOSE]+"|"+src[NONNUMERICIDENTIFIER]+")";var PRERELEASE=R++;src[PRERELEASE]="(?:-("+src[PRERELEASEIDENTIFIER]+"(?:\\."+src[PRERELEASEIDENTIFIER]+")*))";var PRERELEASELOOSE=R++;src[PRERELEASELOOSE]="(?:-?("+src[PRERELEASEIDENTIFIERLOOSE]+"(?:\\."+src[PRERELEASEIDENTIFIERLOOSE]+")*))";var BUILDIDENTIFIER=R++;src[BUILDIDENTIFIER]="[0-9A-Za-z-]+";var BUILD=R++;src[BUILD]="(?:\\+("+src[BUILDIDENTIFIER]+"(?:\\."+src[BUILDIDENTIFIER]+")*))";var FULL=R++;var FULLPLAIN="v?"+src[MAINVERSION]+src[PRERELEASE]+"?"+src[BUILD]+"?";src[FULL]="^"+FULLPLAIN+"$";var LOOSEPLAIN="[v=\\s]*"+src[MAINVERSIONLOOSE]+src[PRERELEASELOOSE]+"?"+src[BUILD]+"?";var LOOSE=R++;src[LOOSE]="^"+LOOSEPLAIN+"$";var GTLT=R++;src[GTLT]="((?:<|>)?=?)";var XRANGEIDENTIFIERLOOSE=R++;src[XRANGEIDENTIFIERLOOSE]=src[NUMERICIDENTIFIERLOOSE]+"|x|X|\\*";var XRANGEIDENTIFIER=R++;src[XRANGEIDENTIFIER]=src[NUMERICIDENTIFIER]+"|x|X|\\*";var XRANGEPLAIN=R++;src[XRANGEPLAIN]="[v=\\s]*("+src[XRANGEIDENTIFIER]+")"+"(?:\\.("+src[XRANGEIDENTIFIER]+")"+"(?:\\.("+src[XRANGEIDENTIFIER]+")"+"(?:("+src[PRERELEASE]+")"+")?)?)?";var XRANGEPLAINLOOSE=R++;src[XRANGEPLAINLOOSE]="[v=\\s]*("+src[XRANGEIDENTIFIERLOOSE]+")"+"(?:\\.("+src[XRANGEIDENTIFIERLOOSE]+")"+"(?:\\.("+src[XRANGEIDENTIFIERLOOSE]+")"+"(?:("+src[PRERELEASELOOSE]+")"+")?)?)?";var XRANGE=R++;src[XRANGE]="^"+src[GTLT]+"\\s*"+src[XRANGEPLAIN]+"$";var XRANGELOOSE=R++;src[XRANGELOOSE]="^"+src[GTLT]+"\\s*"+src[XRANGEPLAINLOOSE]+"$";var LONETILDE=R++;src[LONETILDE]="(?:~>?)";var TILDETRIM=R++;src[TILDETRIM]="(\\s*)"+src[LONETILDE]+"\\s+";re[TILDETRIM]=new RegExp(src[TILDETRIM],"g");var tildeTrimReplace="$1~";var TILDE=R++;src[TILDE]="^"+src[LONETILDE]+src[XRANGEPLAIN]+"$";var TILDELOOSE=R++;src[TILDELOOSE]="^"+src[LONETILDE]+src[XRANGEPLAINLOOSE]+"$";var LONECARET=R++;src[LONECARET]="(?:\\^)";var CARETTRIM=R++;src[CARETTRIM]="(\\s*)"+src[LONECARET]+"\\s+";re[CARETTRIM]=new RegExp(src[CARETTRIM],"g");var caretTrimReplace="$1^";var CARET=R++;src[CARET]="^"+src[LONECARET]+src[XRANGEPLAIN]+"$";var CARETLOOSE=R++;src[CARETLOOSE]="^"+src[LONECARET]+src[XRANGEPLAINLOOSE]+"$";var COMPARATORLOOSE=R++;src[COMPARATORLOOSE]="^"+src[GTLT]+"\\s*("+LOOSEPLAIN+")$|^$";var COMPARATOR=R++;src[COMPARATOR]="^"+src[GTLT]+"\\s*("+FULLPLAIN+")$|^$";var COMPARATORTRIM=R++;src[COMPARATORTRIM]="(\\s*)"+src[GTLT]+"\\s*("+LOOSEPLAIN+"|"+src[XRANGEPLAIN]+")";re[COMPARATORTRIM]=new RegExp(src[COMPARATORTRIM],"g");var comparatorTrimReplace="$1$2$3";var HYPHENRANGE=R++;src[HYPHENRANGE]="^\\s*("+src[XRANGEPLAIN]+")"+"\\s+-\\s+"+"("+src[XRANGEPLAIN]+")"+"\\s*$";var HYPHENRANGELOOSE=R++;src[HYPHENRANGELOOSE]="^\\s*("+src[XRANGEPLAINLOOSE]+")"+"\\s+-\\s+"+"("+src[XRANGEPLAINLOOSE]+")"+"\\s*$";var STAR=R++;src[STAR]="(<|>)?=?\\s*\\*";for(var i=0;i<R;i++){if(!re[i])re[i]=new RegExp(src[i])}exports.parse=parse;function parse(version,loose){var r=loose?re[LOOSE]:re[FULL];return r.test(version)?new SemVer(version,loose):null}exports.valid=valid;function valid(version,loose){var v=parse(version,loose);return v?v.version:null}exports.clean=clean;function clean(version,loose){var s=parse(version,loose);return s?s.version:null}exports.SemVer=SemVer;function SemVer(version,loose){if(version instanceof SemVer){if(version.loose===loose)return version;else version=version.version}else if(typeof version!=="string"){throw new TypeError("Invalid Version: "+version)}if(!(this instanceof SemVer))return new SemVer(version,loose);this.loose=loose;var m=version.trim().match(loose?re[LOOSE]:re[FULL]);if(!m)throw new TypeError("Invalid Version: "+version);this.raw=version;this.major=+m[1];this.minor=+m[2];this.patch=+m[3];if(!m[4])this.prerelease=[];else this.prerelease=m[4].split(".").map(function(id){return/^[0-9]+$/.test(id)?+id:id});this.build=m[5]?m[5].split("."):[];this.format()}SemVer.prototype.format=function(){this.version=this.major+"."+this.minor+"."+this.patch;if(this.prerelease.length)this.version+="-"+this.prerelease.join(".");return this.version};SemVer.prototype.inspect=function(){return'<SemVer "'+this+'">'};SemVer.prototype.toString=function(){return this.version};SemVer.prototype.compare=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return this.compareMain(other)||this.comparePre(other)};SemVer.prototype.compareMain=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);return compareIdentifiers(this.major,other.major)||compareIdentifiers(this.minor,other.minor)||compareIdentifiers(this.patch,other.patch)};SemVer.prototype.comparePre=function(other){if(!(other instanceof SemVer))other=new SemVer(other,this.loose);if(this.prerelease.length&&!other.prerelease.length)return-1;else if(!this.prerelease.length&&other.prerelease.length)return 1;else if(!this.prerelease.length&&!other.prerelease.length)return 0;var i=0;do{var a=this.prerelease[i];var b=other.prerelease[i];if(a===undefined&&b===undefined)return 0;else if(b===undefined)return 1;else if(a===undefined)return-1;else if(a===b)continue;else return compareIdentifiers(a,b)}while(++i)};SemVer.prototype.inc=function(release){switch(release){case"premajor":this.inc("major");this.inc("pre");break;case"preminor":this.inc("minor");this.inc("pre");break;case"prepatch":this.prerelease.length=0;this.inc("patch");this.inc("pre");break;case"prerelease":if(this.prerelease.length===0)this.inc("patch");this.inc("pre");break;case"major":this.major++;this.minor=-1;case"minor":this.minor++;this.patch=0;this.prerelease=[];break;case"patch":if(this.prerelease.length===0)this.patch++;this.prerelease=[];break;case"pre":if(this.prerelease.length===0)this.prerelease=[0];else{var i=this.prerelease.length;while(--i>=0){if(typeof this.prerelease[i]==="number"){this.prerelease[i]++;i=-2}}if(i===-1)this.prerelease.push(0)}break;default:throw new Error("invalid increment argument: "+release)}this.format();return this};exports.inc=inc;function inc(version,release,loose){try{return new SemVer(version,loose).inc(release).version}catch(er){return null}}exports.compareIdentifiers=compareIdentifiers;var numeric=/^[0-9]+$/;function compareIdentifiers(a,b){var anum=numeric.test(a);var bnum=numeric.test(b);if(anum&&bnum){a=+a;b=+b}return anum&&!bnum?-1:bnum&&!anum?1:a<b?-1:a>b?1:0}exports.rcompareIdentifiers=rcompareIdentifiers;function rcompareIdentifiers(a,b){return compareIdentifiers(b,a)}exports.compare=compare;function compare(a,b,loose){return new SemVer(a,loose).compare(b)}exports.compareLoose=compareLoose;function compareLoose(a,b){return compare(a,b,true)}exports.rcompare=rcompare;function rcompare(a,b,loose){return compare(b,a,loose)}exports.sort=sort;function sort(list,loose){return list.sort(function(a,b){return exports.compare(a,b,loose)})}exports.rsort=rsort;function rsort(list,loose){return list.sort(function(a,b){return exports.rcompare(a,b,loose)})}exports.gt=gt;function gt(a,b,loose){return compare(a,b,loose)>0}exports.lt=lt;function lt(a,b,loose){return compare(a,b,loose)<0}exports.eq=eq;function eq(a,b,loose){return compare(a,b,loose)===0}exports.neq=neq;function neq(a,b,loose){return compare(a,b,loose)!==0}exports.gte=gte;function gte(a,b,loose){return compare(a,b,loose)>=0}exports.lte=lte;function lte(a,b,loose){return compare(a,b,loose)<=0}exports.cmp=cmp;function cmp(a,op,b,loose){var ret;switch(op){case"===":ret=a===b;break;case"!==":ret=a!==b;break;case"":case"=":case"==":ret=eq(a,b,loose);break;case"!=":ret=neq(a,b,loose);break;case">":ret=gt(a,b,loose);break;case">=":ret=gte(a,b,loose);break;case"<":ret=lt(a,b,loose);break;case"<=":ret=lte(a,b,loose);break;default:throw new TypeError("Invalid operator: "+op)}return ret}exports.Comparator=Comparator;function Comparator(comp,loose){if(comp instanceof Comparator){if(comp.loose===loose)return comp;else comp=comp.value}if(!(this instanceof Comparator))return new Comparator(comp,loose);this.loose=loose;this.parse(comp);if(this.semver===ANY)this.value="";else this.value=this.operator+this.semver.version}var ANY={};Comparator.prototype.parse=function(comp){var r=this.loose?re[COMPARATORLOOSE]:re[COMPARATOR];var m=comp.match(r);if(!m)throw new TypeError("Invalid comparator: "+comp);this.operator=m[1];if(!m[2])this.semver=ANY;else{this.semver=new SemVer(m[2],this.loose);if(this.operator==="<"&&!this.semver.prerelease.length){this.semver.prerelease=["0"];this.semver.format()}}};Comparator.prototype.inspect=function(){return'<SemVer Comparator "'+this+'">'};Comparator.prototype.toString=function(){return this.value};Comparator.prototype.test=function(version){return this.semver===ANY?true:cmp(version,this.operator,this.semver,this.loose)};exports.Range=Range;function Range(range,loose){if(range instanceof Range&&range.loose===loose)return range;if(!(this instanceof Range))return new Range(range,loose);this.loose=loose;this.raw=range;this.set=range.split(/\s*\|\|\s*/).map(function(range){return this.parseRange(range.trim())},this).filter(function(c){return c.length});if(!this.set.length){throw new TypeError("Invalid SemVer Range: "+range)}this.format()}Range.prototype.inspect=function(){return'<SemVer Range "'+this.range+'">'};Range.prototype.format=function(){this.range=this.set.map(function(comps){return comps.join(" ").trim()}).join("||").trim();return this.range};Range.prototype.toString=function(){return this.range};Range.prototype.parseRange=function(range){var loose=this.loose;range=range.trim();var hr=loose?re[HYPHENRANGELOOSE]:re[HYPHENRANGE];range=range.replace(hr,hyphenReplace);range=range.replace(re[COMPARATORTRIM],comparatorTrimReplace);range=range.replace(re[TILDETRIM],tildeTrimReplace);range=range.replace(re[CARETTRIM],caretTrimReplace);range=range.split(/\s+/).join(" ");var compRe=loose?re[COMPARATORLOOSE]:re[COMPARATOR];var set=range.split(" ").map(function(comp){return parseComparator(comp,loose)}).join(" ").split(/\s+/);if(this.loose){set=set.filter(function(comp){return!!comp.match(compRe)})}set=set.map(function(comp){return new Comparator(comp,loose)});return set};exports.toComparators=toComparators;function toComparators(range,loose){return new Range(range,loose).set.map(function(comp){return comp.map(function(c){return c.value}).join(" ").trim().split(" ")})}function parseComparator(comp,loose){comp=replaceCarets(comp,loose);comp=replaceTildes(comp,loose);comp=replaceXRanges(comp,loose);comp=replaceStars(comp,loose);return comp}function isX(id){return!id||id.toLowerCase()==="x"||id==="*"}function replaceTildes(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceTilde(comp,loose)}).join(" ")}function replaceTilde(comp,loose){var r=loose?re[TILDELOOSE]:re[TILDE];return comp.replace(r,function(_,M,m,p,pr){var ret;if(isX(M))ret="";else if(isX(m))ret=">="+M+".0.0-0 <"+(+M+1)+".0.0-0";else if(isX(p))ret=">="+M+"."+m+".0-0 <"+M+"."+(+m+1)+".0-0";else if(pr){if(pr.charAt(0)!=="-")pr="-"+pr;ret=">="+M+"."+m+"."+p+pr+" <"+M+"."+(+m+1)+".0-0"}else ret=">="+M+"."+m+"."+p+"-0"+" <"+M+"."+(+m+1)+".0-0";return ret})}function replaceCarets(comp,loose){return comp.trim().split(/\s+/).map(function(comp){return replaceCaret(comp,loose)}).join(" ")}function replaceCaret(comp,loose){var r=loose?re[CARETLOOSE]:re[CARET];return comp.replace(r,function(_,M,m,p,pr){var ret;if(isX(M))ret="";else if(isX(m))ret=">="+M+".0.0-0 <"+(+M+1)+".0.0-0";else if(isX(p)){if(M==="0")ret=">="+M+"."+m+".0-0 <"+M+"."+(+m+1)+".0-0";else ret=">="+M+"."+m+".0-0 <"+(+M+1)+".0.0-0"}else if(pr){if(pr.charAt(0)!=="-")pr="-"+pr;if(M==="0"){if(m==="0")ret="="+M+"."+m+"."+p+pr;else ret=">="+M+"."+m+"."+p+pr+" <"+M+"."+(+m+1)+".0-0"}else ret=">="+M+"."+m+"."+p+pr+" <"+(+M+1)+".0.0-0"}else{if(M==="0"){if(m==="0")ret="="+M+"."+m+"."+p;else ret=">="+M+"."+m+"."+p+"-0"+" <"+M+"."+(+m+1)+".0-0"}else ret=">="+M+"."+m+"."+p+"-0"+" <"+(+M+1)+".0.0-0"}return ret})}function replaceXRanges(comp,loose){return comp.split(/\s+/).map(function(comp){return replaceXRange(comp,loose)}).join(" ")}function replaceXRange(comp,loose){comp=comp.trim();var r=loose?re[XRANGELOOSE]:re[XRANGE];return comp.replace(r,function(ret,gtlt,M,m,p,pr){var xM=isX(M);var xm=xM||isX(m);var xp=xm||isX(p);var anyX=xp;if(gtlt==="="&&anyX)gtlt="";if(gtlt&&anyX){if(xM)M=0;if(xm)m=0;if(xp)p=0;if(gtlt===">"){gtlt=">=";if(xM){}else if(xm){M=+M+1;m=0;p=0}else if(xp){m=+m+1;p=0}}ret=gtlt+M+"."+m+"."+p+"-0"}else if(xM){ret="*"}else if(xm){ret=">="+M+".0.0-0 <"+(+M+1)+".0.0-0"}else if(xp){ret=">="+M+"."+m+".0-0 <"+M+"."+(+m+1)+".0-0"}return ret})}function replaceStars(comp,loose){return comp.trim().replace(re[STAR],"")}function hyphenReplace($0,from,fM,fm,fp,fpr,fb,to,tM,tm,tp,tpr,tb){if(isX(fM))from="";else if(isX(fm))from=">="+fM+".0.0-0";else if(isX(fp))from=">="+fM+"."+fm+".0-0";else from=">="+from;if(isX(tM))to="";else if(isX(tm))to="<"+(+tM+1)+".0.0-0";else if(isX(tp))to="<"+tM+"."+(+tm+1)+".0-0";else if(tpr)to="<="+tM+"."+tm+"."+tp+"-"+tpr;else to="<="+to;return(from+" "+to).trim()}Range.prototype.test=function(version){if(!version)return false;for(var i=0;i<this.set.length;i++){if(testSet(this.set[i],version))return true}return false};function testSet(set,version){for(var i=0;i<set.length;i++){if(!set[i].test(version))return false}return true}exports.satisfies=satisfies;function satisfies(version,range,loose){try{range=new Range(range,loose)}catch(er){return false}return range.test(version)}exports.maxSatisfying=maxSatisfying;function maxSatisfying(versions,range,loose){return versions.filter(function(version){return satisfies(version,range,loose)}).sort(function(a,b){return rcompare(a,b,loose)})[0]||null}exports.validRange=validRange;function validRange(range,loose){try{return new Range(range,loose).range||"*"}catch(er){return null}}exports.ltr=ltr;function ltr(version,range,loose){return outside(version,range,"<",loose)}exports.gtr=gtr;function gtr(version,range,loose){return outside(version,range,">",loose)}exports.outside=outside;function outside(version,range,hilo,loose){version=new SemVer(version,loose);range=new Range(range,loose);var gtfn,ltefn,ltfn,comp,ecomp;switch(hilo){case">":gtfn=gt;ltefn=lte;ltfn=lt;comp=">";ecomp=">=";break;case"<":gtfn=lt;ltefn=gte;ltfn=gt;comp="<";ecomp="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(satisfies(version,range,loose)){return false}for(var i=0;i<range.set.length;++i){var comparators=range.set[i];var high=null;var low=null;comparators.forEach(function(comparator){high=high||comparator;low=low||comparator;if(gtfn(comparator.semver,high.semver,loose)){high=comparator}else if(ltfn(comparator.semver,low.semver,loose)){low=comparator}});if(high.operator===comp||high.operator===ecomp){return false}if((!low.operator||low.operator===comp)&&ltefn(version,low.semver)){return false}else if(low.operator===ecomp&&ltfn(version,low.semver)){return false}}return true}if(typeof define==="function"&&define.amd)define(exports)})(typeof exports==="object"?exports:typeof define==="function"&&define.amd?{}:semver={})},{}],40:[function(require,module,exports){var detect=require("./detect");var requiredFunctions=["init"];function isSupported(plugin){return plugin&&typeof plugin.supported=="function"&&plugin.supported(detect)}function isValid(plugin){var supportedFunctions=requiredFunctions.filter(function(fn){return typeof plugin[fn]=="function"});return supportedFunctions.length===requiredFunctions.length}module.exports=function(plugins){return[].concat(plugins||[]).filter(isSupported).filter(isValid)[0]}},{"./detect":38}],41:[function(require,module,exports){(function(process){"use strict";var EventEmitter=require("events").EventEmitter;var rtc=require("rtc-tools");var cleanup=require("rtc-tools/cleanup");var debug=rtc.logger("rtc-quickconnect");var signaller=require("rtc-signaller");var defaults=require("cog/defaults");var extend=require("cog/extend");var FastMap=require("collections/fast-map");var reTrailingSlash=/\/$/;module.exports=function(signalhost,opts){var hash=typeof location!="undefined"&&location.hash.slice(1);var signaller=require("rtc-signaller")(signalhost,opts);
var ns=(opts||{}).ns||"";var room=(opts||{}).room;var debugging=(opts||{}).debug;var profile={};var announced=false;var localStreams=[];var calls=signaller.calls=new FastMap;var channels={};function callCreate(id,pc,data){calls.set(id,{active:false,pc:pc,channels:new FastMap,data:data,streams:[]})}function callEnd(id){var call=calls.get(id);if(!call){return}debug("ending call to: "+id);call.channels.keys().forEach(function(label){var args=[id,call.channels.get(label),label];signaller.emit.apply(signaller,["channel:closed"].concat(args));signaller.emit.apply(signaller,["channel:closed:"+label].concat(args))});call.streams.forEach(function(stream){signaller.emit("stream:removed",id,stream)});signaller.emit("call:ended",id,call.pc);cleanup(call.pc);calls.delete(id)}function callStart(id,pc,data){var call=calls.get(id);var streams=[].concat(pc.getRemoteStreams());call.active=true;call.streams=[].concat(pc.getRemoteStreams());pc.onaddstream=createStreamAddHandler(id);pc.onremovestream=createStreamRemoveHandler(id);debug(signaller.id+" - "+id+" call start: "+streams.length+" streams");signaller.emit("call:started",id,pc,data);process.nextTick(function(){streams.forEach(receiveRemoteStream(id))})}function createStreamAddHandler(id){return function(evt){debug("peer "+id+" added stream");updateRemoteStreams(id);receiveRemoteStream(id)(evt.stream)}}function createStreamRemoveHandler(id){return function(evt){debug("peer "+id+" removed stream");updateRemoteStreams(id);signaller.emit("stream:removed",id,evt.stream)}}function getActiveCall(peerId){var call=calls.get(peerId);if(!call){throw new Error("No active call for peer: "+peerId)}return call}function gotPeerChannel(channel,pc,data){var channelMonitor;function channelReady(){var call=calls.get(data.id);var args=[data.id,channel,data,pc];debug('reporting channel "'+channel.label+'" ready, have call: '+!!call);clearInterval(channelMonitor);channel.onopen=null;if(call){call.channels.set(channel.label,channel)}debug("triggering channel:opened events for channel: "+channel.label);signaller.emit.apply(signaller,["channel:opened"].concat(args));signaller.emit.apply(signaller,["channel:opened:"+channel.label].concat(args))}debug("channel "+channel.label+" discovered for peer: "+data.id);if(channel.readyState==="open"){return channelReady()}debug("channel not ready, current state = "+channel.readyState);channel.onopen=channelReady;channelMonitor=setInterval(function(){debug("checking channel state, current state = "+channel.readyState);if(channel.readyState==="open"){channelReady()}},500)}function handlePeerAnnounce(data){var pc;var monitor;if(data.room!==room){return}pc=rtc.createConnection(opts,(opts||{}).constraints);callCreate(data.id,pc,data);localStreams.forEach(function(stream,idx){pc.addStream(stream)});if(signaller.isMaster(data.id)){debug("is master, creating data channels: ",Object.keys(channels));Object.keys(channels).forEach(function(label){gotPeerChannel(pc.createDataChannel(label,channels[label]),pc,data)})}else{pc.ondatachannel=function(evt){var channel=evt&&evt.channel;if(!channel){return}if(channels[channel.label]!==undefined){gotPeerChannel(channel,pc,data)}}}debug("coupling "+signaller.id+" to "+data.id);monitor=rtc.couple(pc,data.id,signaller,opts);monitor.once("connected",callStart.bind(null,data.id,pc,data));monitor.once("closed",callEnd.bind(null,data.id));if(signaller.isMaster(data.id)){monitor.createOffer()}}function receiveRemoteStream(id){var call=calls.get(id);return function(stream){signaller.emit("stream:added",id,stream,call&&call.data)}}function updateRemoteStreams(id){var call=calls.get(id);if(call&&call.pc){call.streams=[].concat(call.pc.getRemoteStreams())}}if(!room){if(!hash){hash=location.hash=""+Math.pow(2,53)*Math.random()}room=ns+"#"+hash}if(debugging){rtc.logger.enable.apply(rtc.logger,Array.isArray(debug)?debugging:["*"])}signaller.on("peer:announce",handlePeerAnnounce);signaller.on("peer:leave",callEnd);setTimeout(function(){var data=extend({},profile,{room:room});signaller.announce(data);signaller.emit("local:announce",data);announced=true},0);signaller.broadcast=signaller.addStream=function(stream){localStreams.push(stream);calls.values().forEach(function(data){data.pc.addStream(stream)});return signaller};signaller.close=function(){calls.keys().forEach(callEnd);signaller.leave()};signaller.createDataChannel=function(label,opts){calls.keys().forEach(function(peerId){var call=calls.get(peerId);var dc;if(call&&call.pc&&signaller.isMaster(peerId)){dc=call.pc.createDataChannel(label,opts);gotPeerChannel(dc,call.pc,call.data)}});channels[label]=opts||null;return signaller};signaller.reactive=function(){opts=opts||{};opts.reactive=true;return signaller};signaller.removeStream=function(stream){var localIndex=localStreams.indexOf(stream);calls.values().forEach(function(call){call.pc.removeStream(stream)});if(localIndex>=0){localStreams.splice(localIndex,1)}return signaller};signaller.requestChannel=function(targetId,label,callback){var call=getActiveCall(targetId);var channel;function waitForChannel(){call.channels.removeMapChangeListener(waitForChannel,label);callback(null,call.channels.get(label))}channel=call.channels.get(label);if(channel){callback(null,channel);return signaller}call.channels.addMapChangeListener(waitForChannel,label);return signaller};signaller.requestStream=function(targetId,idx,callback){var call=getActiveCall(targetId);var stream;function waitForStream(peerId){if(peerId!==targetId){return}stream=call.pc.getRemoteStreams()[idx];if(stream){signaller.removeListener("stream:added",waitForStream);callback(null,stream)}}stream=call.pc.getRemoteStreams()[idx];if(stream){callback(null,stream);return signaller}signaller.on("stream:added",waitForStream);return signaller};signaller.profile=function(data){extend(profile,data);if(announced){signaller.announce(profile)}return signaller};signaller.waitForCall=function(targetId,callback){var call=calls.get(targetId);if(call&&call.active){callback(null,call.pc);return signaller}signaller.on("call:started",function handleNewCall(id){if(id===targetId){signaller.removeListener("call:started",handleNewCall);callback(null,calls.get(id).pc)}})};return signaller}}).call(this,require("FWaASH"))},{FWaASH:4,"cog/defaults":12,"cog/extend":13,"collections/fast-map":18,events:2,"rtc-signaller":50,"rtc-tools":58,"rtc-tools/cleanup":54}],42:[function(require,module,exports){module.exports=require(38)},{FWaASH:4,semver:43}],43:[function(require,module,exports){module.exports=require(39)},{}],44:[function(require,module,exports){var detect=require("./detect");var url=require("url");module.exports=function(server){var uri;var auth;if(server&&server.url){uri=url.parse(server.url);auth=(uri.auth||"").split(":");return{url:uri.protocol+uri.host+(uri.search||""),urls:[uri.protocol+uri.host+(uri.search||"")],username:auth[0],credential:server.credential||auth[1]}}return server}},{"./detect":42,url:9}],45:[function(require,module,exports){module.exports=require(40)},{"./detect":42}],46:[function(require,module,exports){module.exports={dataEvent:"data",openEvent:"open",closeEvent:"close",writeMethod:"write",closeMethod:"close",leaveTimeout:3e3}},{}],47:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var extend=require("cog/extend");var roles=["a","b"];module.exports=function(signaller){function copyData(target,source){if(target&&source){for(var key in source){target[key]=source[key]}}return target}function dataAllowed(data){var evt={data:data,allow:true};signaller.emit("peer:filter",evt);return evt.allow}return function(args,messageType,srcData,srcState,isDM){var data=args[0];var peer;debug("announce handler invoked, received data: ",data);if(data&&data.id&&data.id!==signaller.id){if(!dataAllowed(data)){return}peer=signaller.peers.get(data.id);signaller.emit("peer:connected",data.id,data);if(peer&&!peer.inactive){debug("signaller: "+signaller.id+" received update, data: ",data);copyData(peer.data,data);return signaller.emit("peer:update",data,srcData)}peer={id:data.id,roleIdx:[data.id,signaller.id].sort().indexOf(data.id),data:{}};copyData(peer.data,data);clearTimeout(peer.leaveTimer);peer.inactive=false;signaller.peers.set(data.id,peer);if(signaller.autoreply&&!isDM){signaller.to(data.id).send("/announce",signaller.attributes)}return signaller.emit("peer:announce",data,peer)}}}},{"cog/extend":13,"cog/logger":15}],48:[function(require,module,exports){"use strict";module.exports=function(signaller,opts){return{announce:require("./announce")(signaller,opts),leave:require("./leave")(signaller,opts)}}},{"./announce":47,"./leave":49}],49:[function(require,module,exports){"use strict";module.exports=function(signaller,opts){return function(args){var data=args[0];var peer=signaller.peers.get(data&&data.id);if(peer){peer.leaveTimer=setTimeout(function(){peer.inactive=true;signaller.emit("peer:leave",data.id,peer)},opts.leaveTimeout)}signaller.emit("peer:disconnected",data.id,peer)}}},{}],50:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var detect=require("rtc-core/detect");var EventEmitter=require("events").EventEmitter;var defaults=require("cog/defaults");var extend=require("cog/extend");var throttle=require("cog/throttle");var uuid=require("./uuid");var FastMap=require("collections/fast-map");var WRITE_METHODS=["write","send"];var CLOSE_METHODS=["close","end"];var metadata={version:"1.3.0"};var sig=module.exports=function(messenger,opts){var autoreply=(opts||{}).autoreply;var localMeta={};var signaller=new EventEmitter;var id=signaller.id=(opts||{}).id||uuid();var attributes=signaller.attributes={browser:detect.browser,browserVersion:detect.browserVersion,id:id,agent:"signaller@"+metadata.version};var peers=signaller.peers=new FastMap;var connected=false;var write;var close;var processor;var announceTimer=0;function announceOnReconnect(){signaller.announce()}function bindBrowserEvents(){messenger.addEventListener("message",function(evt){processor(evt.data)});messenger.addEventListener("open",function(evt){signaller.emit("open");signaller.emit("connected")})}function bindEvents(){if(typeof messenger.on!="function"){return}messenger.on(opts.dataEvent,processor);messenger.on(opts.openEvent,function(){signaller.emit("open");signaller.emit("connected")});messenger.on(opts.closeEvent,function(){signaller.emit("disconnected")})}function connectToPrimus(url){sig.loadPrimus(url,function(err,Primus){if(err){return signaller.emit("error",err)}signaller._messenger=messenger=Primus.connect(url);init()})}function createDataLine(args){return args.map(prepareArg).join("|")}function createMetadata(){return extend({},localMeta,{id:signaller.id})}function extractProp(name){return messenger[name]}function isF(target){return typeof target=="function"}function init(){write=[opts.writeMethod].concat(WRITE_METHODS).map(extractProp).filter(isF)[0];close=[opts.closeMethod].concat(CLOSE_METHODS).map(extractProp).filter(isF)[0];signaller.process=processor=require("./processor")(signaller,opts);if(typeof write!="function"){throw new Error('provided messenger does not implement a "'+writeMethod+'" write method')}if(typeof messenger.addEventListener=="function"){bindBrowserEvents()}else{bindEvents()}connected=messenger.connected||false;if(!connected){signaller.once("connected",function(){connected=true;signaller.on("connected",announceOnReconnect)})}setTimeout(signaller.emit.bind(signaller,"init"),0)}function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}var send=signaller.send=function(){var args=[].slice.call(arguments);var dataline;args.splice(1,0,createMetadata());dataline=createDataLine(args);if(!connected){return signaller.once("connected",function(){write.call(messenger,dataline)})}return write.call(messenger,dataline)};signaller.announce=function(data,sender){clearTimeout(announceTimer);extend(attributes,data,{id:signaller.id});if(connected){signaller.removeListener("connected",announceOnReconnect);signaller.on("connected",announceOnReconnect)}return announceTimer=setTimeout(function(){(sender||send)("/announce",attributes)},(opts||{}).announceDelay||10)};signaller.isMaster=function(targetId){var peer=peers.get(targetId);return peer&&peer.roleIdx!==0};signaller.leave=signaller.close=function(){send("/leave",{id:id});signaller.removeListener("connected",announceOnReconnect);if(typeof close=="function"){close.call(messenger)}};signaller.metadata=function(data){if(arguments.length===0){return extend({},localMeta)}localMeta=extend({},data)};signaller.to=function(targetId){var sender=function(){var peer=signaller.peers.get(targetId);var args;if(!peer){throw new Error("Unknown peer: "+targetId)}if(peer.inactive){return}args=["/to",targetId].concat([].slice.call(arguments));args.splice(3,0,createMetadata());setTimeout(function(){var msg=createDataLine(args);debug("TX ("+targetId+"): "+msg);write.call(messenger,msg)},0)};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};signaller.setMaxListeners(0);opts=defaults({},opts,require("./defaults"));signaller.autoreply=autoreply===undefined||autoreply;if(typeof messenger=="string"||messenger instanceof String){connectToPrimus(messenger)}else{init()}signaller._messenger=messenger;signaller.process=processor;return signaller};sig.loadPrimus=require("./primus-loader")},{"./defaults":46,"./primus-loader":51,"./processor":52,"./uuid":53,"cog/defaults":12,"cog/extend":13,"cog/logger":15,"cog/throttle":16,"collections/fast-map":18,events:2,"rtc-core/detect":42}],51:[function(require,module,exports){"use strict";var reTrailingSlash=/\/$/;module.exports=function(signalhost,callback){var anchor=document.createElement("a");var script;var baseUrl;var scriptSrc;if(typeof signalhost=="function"){callback=signalhost;signalhost=location.origin}anchor.href=signalhost;baseUrl=signalhost.replace(reTrailingSlash,"");scriptSrc=baseUrl+"/rtc.io/primus.js";script=document.querySelector('script[src="'+scriptSrc+'"]');if(script&&typeof Primus!="undefined"){return callback(null,Primus)}else if(script){script.addEventListener("load",function(){callback(null,Primus)});return}script=document.createElement("script");script.src=scriptSrc;script.onerror=callback;script.addEventListener("load",function(){if(anchor.pathname!=="/"){Primus.prototype.pathname=anchor.pathname.replace(reTrailingSlash,"")+Primus.prototype.pathname}callback(null,Primus)});document.body.appendChild(script)}},{}],52:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var jsonparse=require("cog/jsonparse");module.exports=function(signaller,opts){var handlers=require("./handlers")(signaller,opts);function sendEvent(parts,srcState,data){var evtName=parts[0].slice(1);var args=parts.slice(2).map(jsonparse);signaller.emit.apply(signaller,[evtName].concat(args).concat([srcState,data]))}return function(originalData){var data=originalData;var isMatch=true;var parts;var handler;var srcData;var srcState;var isDirectMessage=false;var id=signaller.id+"";debug("signaller "+id+" received data: "+originalData);if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){parts=data.slice(5+id.length).split("|").map(jsonparse);isDirectMessage=true;parts=parts.map(jsonparse)}}if(!isMatch){return}parts=parts||data.split("|").map(jsonparse);if(typeof parts[0]=="string"){srcData=parts[1];if(srcData&&srcData.id===signaller.id){return console.warn("got data from ourself, discarding")}srcState=signaller.peers.get(srcData&&srcData.id)||srcData;if(parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];if(typeof handler=="function"){handler(parts.slice(2),parts[0].slice(1),srcData,srcState,isDirectMessage)}else{sendEvent(parts,srcState,originalData)}}else{signaller.emit("data",parts.slice(0,1).concat(parts.slice(2)),srcData,srcState,isDirectMessage)}}}}},{"./handlers":48,"cog/jsonparse":14,"cog/logger":15}],53:[function(require,module,exports){module.exports=function(a,b){for(b=a="";a++<36;b+=a*51&52?(a^15?8^Math.random()*(a^20?16:4):4).toString(16):"-");return b}},{}],54:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc/cleanup");var CANNOT_CLOSE_STATES=["closed"];var EVENTNAMES=["addstream","datachannel","icecandidate","iceconnectionstatechange","negotiationneeded","removestream","signalingstatechange"];module.exports=function(pc){var currentState=pc.iceConnectionState;var canClose=CANNOT_CLOSE_STATES.indexOf(currentState)<0;if(canClose){debug("attempting connection close, current state: "+pc.iceConnectionState);pc.close()}setTimeout(function(){EVENTNAMES.forEach(function(evtName){if(pc["on"+evtName]){pc["on"+evtName]=null}})},100)}},{"cog/logger":15}],55:[function(require,module,exports){"use strict";var async=require("async");var cleanup=require("./cleanup");var monitor=require("./monitor");var detect=require("./detect");var findPlugin=require("rtc-core/plugin");var CLOSED_STATES=["closed","failed"];var OFFER_ANSWER_CONSTRAINTS=["offerToReceiveVideo","offerToReceiveAudio","voiceActivityDetection","iceRestart"];function couple(pc,targetId,signaller,opts){var debugLabel=(opts||{}).debugLabel||"rtc";var debug=require("cog/logger")(debugLabel+"/couple");var mon=monitor(pc,targetId,signaller,opts);var queuedCandidates=[];var sdpFilter=(opts||{}).sdpfilter;var reactive=(opts||{}).reactive;var offerTimeout;var endOfCandidates=true;var plugin=findPlugin((opts||{}).plugins);var disconnectTimeout=(opts||{}).disconnectTimeout||1e4;var disconnectTimer;if(typeof signaller.isMaster!="function"){throw new Error("rtc-signaller instance >= 0.14.0 required")}var isMaster=signaller.isMaster(targetId);var createOffer=prepNegotiate("createOffer",isMaster,[checkStable]);var createAnswer=prepNegotiate("createAnswer",true,[]);var q=async.queue(function(task,cb){if(typeof task.op!="function"){return cb()}task.op(task,cb)},1);var RTCSessionDescription=(opts||{}).RTCSessionDescription||detect("RTCSessionDescription");var RTCIceCandidate=(opts||{}).RTCIceCandidate||detect("RTCIceCandidate");function abort(stage,sdp,cb){return function(err){console.error("rtc/couple error ("+stage+"): ",err);if(typeof cb=="function"){cb(err)}}}function applyCandidatesWhenStable(){if(pc.signalingState=="stable"&&pc.remoteDescription){debug("signaling state = stable, applying queued candidates");mon.removeListener("change",applyCandidatesWhenStable);queuedCandidates.splice(0).forEach(function(data){debug("applying queued candidate",data);try{pc.addIceCandidate(createIceCandidate(data))}catch(e){debug("invalidate candidate specified: ",data)}})}}function checkNotConnecting(negotiate){if(pc.iceConnectionState!="checking"){return true}debug("connection state is checking, will wait to create a new offer");mon.once("connected",function(){q.push({op:negotiate})});return false}function checkStable(negotiate){if(pc.signalingState==="stable"){return true}debug("cannot create offer, signaling state != stable, will retry");mon.on("change",function waitForStable(){if(pc.signalingState==="stable"){q.push({op:negotiate})}mon.removeListener("change",waitForStable)});return false}function createIceCandidate(data){if(plugin&&typeof plugin.createIceCandidate=="function"){return plugin.createIceCandidate(data)}return new RTCIceCandidate(data)}function createSessionDescription(data){if(plugin&&typeof plugin.createSessionDescription=="function"){return plugin.createSessionDescription(data)}return new RTCSessionDescription(data)}function decouple(){debug("decoupling "+signaller.id+" from "+targetId);mon.removeAllListeners();mon.stop();cleanup(pc);signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleRemoteCandidate);signaller.removeListener("negotiate",handleNegotiateRequest)}function generateConstraints(methodName){var constraints={};function reformatConstraints(){var tweaked={};Object.keys(constraints).forEach(function(param){var sentencedCased=param.charAt(0).toUpperCase()+param.substr(1);tweaked[sentencedCased]=constraints[param]});constraints={mandatory:tweaked}}OFFER_ANSWER_CONSTRAINTS.forEach(function(param){var sentencedCased=param.charAt(0).toUpperCase()+param.substr(1);if(!opts){return}else if(opts[param]!==undefined){constraints[param]=opts[param]}else if(opts[sentencedCased]!==undefined){constraints[param]=opts[sentencedCased]}});reformatConstraints();return constraints}function prepNegotiate(methodName,allowed,preflightChecks){var constraints=generateConstraints(methodName);preflightChecks=[].concat(preflightChecks||[]);return function negotiate(task,cb){var checksOK=true;if(!allowed){signaller.to(targetId).send("/negotiate");return cb()}if(isClosed()){return cb(new Error("connection closed, cannot negotiate"))}preflightChecks.forEach(function(check){checksOK=checksOK&&check(negotiate)});if(!checksOK){debug("preflight checks did not pass, aborting "+methodName);return cb()}debug("calling "+methodName);pc[methodName](function(desc){if(typeof sdpFilter=="function"){desc.sdp=sdpFilter(desc.sdp,pc,methodName)}q.push({op:queueLocalDesc(desc)});cb()},abort(methodName,"",cb),constraints)}}function handleConnectionClose(){debug("captured pc close, iceConnectionState = "+pc.iceConnectionState);decouple()}function handleDisconnect(){debug("captured pc disconnect, monitoring connection status");disconnectTimer=setTimeout(function(){debug("manually closing connection after disconnect timeout");pc.close()},disconnectTimeout);mon.on("change",handleDisconnectAbort)}function handleDisconnectAbort(){debug("connection state changed to: "+pc.iceConnectionState);resetDisconnectTimer();if(CLOSED_STATES.indexOf(pc.iceConnectionState)>=0){return mon.emit("closed")}mon.once("disconnect",handleDisconnect)}function handleLocalCandidate(evt){if(evt.candidate){resetDisconnectTimer();signaller.to(targetId).send("/candidate",evt.candidate);endOfCandidates=false}else if(!endOfCandidates){endOfCandidates=true;debug("ice gathering state complete");signaller.to(targetId).send("/endofcandidates",{})}}function handleNegotiateRequest(src){if(src.id===targetId){debug("got negotiate request from "+targetId+", creating offer");q.push({op:createOffer})}}function handleRemoteCandidate(data,src){if(!src||src.id!==targetId){return}if(pc.signalingState!="stable"||!pc.remoteDescription){debug("queuing candidate");queuedCandidates.push(data);mon.removeListener("change",applyCandidatesWhenStable);mon.on("change",applyCandidatesWhenStable);return}try{pc.addIceCandidate(createIceCandidate(data))}catch(e){debug("invalidate candidate specified: ",data)}}function handleSdp(data,src){var abortType=data.type==="offer"?"createAnswer":"createOffer";if(!src||src.id!==targetId){return debug("received sdp but dropping due to unmatched src")}q.push({op:function(task,cb){if(isClosed()){return cb(new Error("pc closed: cannot set remote description"))}debug("setting remote description");pc.setRemoteDescription(createSessionDescription(data),function(){if(data.type==="offer"){queue(createAnswer)()}cb()},abort(abortType,data.sdp,cb))}})}function isClosed(){return CLOSED_STATES.indexOf(pc.iceConnectionState)>=0}function queue(negotiateTask){return function(){q.push([{op:negotiateTask}])}}function queueLocalDesc(desc){return function setLocalDesc(task,cb){if(isClosed()){return cb(new Error("connection closed, aborting"))}debug("setting local description");pc.setLocalDescription(desc,function(){signaller.to(targetId).send("/sdp",desc);cb()},function(err){debug("error setting local description",err);debug(desc.sdp);cb(err)})}}function resetDisconnectTimer(){mon.removeListener("change",handleDisconnectAbort);debug("reset disconnect timer, state: "+pc.iceConnectionState);clearTimeout(disconnectTimer)}if(reactive){pc.onnegotiationneeded=function(){debug("renegotiation required, will create offer in 50ms");clearTimeout(offerTimeout);offerTimeout=setTimeout(queue(createOffer),50)}}pc.onicecandidate=handleLocalCandidate;signaller.on("sdp",handleSdp);signaller.on("candidate",handleRemoteCandidate);if(isMaster){signaller.on("negotiate",handleNegotiateRequest)}mon.once("closed",handleConnectionClose);mon.once("disconnected",handleDisconnect);mon.createOffer=queue(createOffer);return mon}module.exports=couple},{"./cleanup":54,"./detect":56,"./monitor":59,async:60,"cog/logger":15,"rtc-core/plugin":45}],56:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":42}],57:[function(require,module,exports){"use strict";var debug=require("cog/logger")("generators");var detect=require("./detect");var defaults=require("cog/defaults");var mappings={create:{dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};exports.config=function(config){return defaults(config,{iceServers:[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;var out;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});out=defaults({},constraints,generated);debug("generated connection constraints: ",out);return out}},{"./detect":56,"cog/defaults":12,"cog/logger":15}],58:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");var findPlugin=require("rtc-core/plugin");var normalizeIce=require("rtc-core/normalize-ice");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");exports.couple=require("./couple");exports.createConnection=function(opts,constraints){var plugin=findPlugin((opts||{}).plugins);var normalize=(plugin?plugin.normalizeIce:null)||normalizeIce;var config=gen.config(opts);var constraints=gen.connectionConstraints(opts,constraints);config.iceServers=(config.iceServers||[]).map(normalize);if(plugin&&typeof plugin.createConnection=="function"){return plugin.createConnection(config,constraints)}else{return new((opts||{}).RTCPeerConnection||RTCPeerConnection)(config,constraints)}}},{"./couple":55,"./detect":56,"./generators":57,"cog/logger":15,"rtc-core/normalize-ice":44,"rtc-core/plugin":45}],59:[function(require,module,exports){"use strict";var EventEmitter=require("events").EventEmitter;var stateMappings={completed:"connected"};var peerStateEvents=["signalingstatechange","iceconnectionstatechange"];module.exports=function(pc,targetId,signaller,opts){var debugLabel=(opts||{}).debugLabel||"rtc";var debug=require("cog/logger")(debugLabel+"/monitor");var monitor=new EventEmitter;var state;function checkState(){var newState=getMappedState(pc.iceConnectionState);debug("state changed: "+pc.iceConnectionState+", mapped: "+newState);monitor.emit("change",pc);if(state!==newState){monitor.emit(newState);state=newState}}function handlePeerLeave(peerId){debug("captured peer leave for peer: "+peerId);if(peerId!==targetId){return}monitor.emit("closed")}pc.onclose=monitor.emit.bind(monitor,"closed");peerStateEvents.forEach(function(evtName){pc["on"+evtName]=checkState});monitor.stop=function(){pc.onclose=null;peerStateEvents.forEach(function(evtName){pc["on"+evtName]=null});if(signaller&&typeof signaller.removeListener=="function"){signaller.removeListener("peer:leave",handlePeerLeave)}};monitor.checkState=checkState;if(!pc){return monitor}state=getMappedState(pc.iceConnectionState);if(signaller&&typeof signaller.on=="function"){signaller.on("peer:leave",handlePeerLeave)}return monitor};function getMappedState(state){return stateMappings[state]||state}},{"cog/logger":15,events:2}],60:[function(require,module,exports){(function(process){(function(){var async={};var root,previous_async;root=this;if(root!=null){previous_async=root.async}async.noConflict=function(){root.async=previous_async;return async};function only_once(fn){var called=false;return function(){if(called)throw new Error("Callback was already called.");called=true;fn.apply(root,arguments)}}var _toString=Object.prototype.toString;var _isArray=Array.isArray||function(obj){return _toString.call(obj)==="[object Array]"};var _each=function(arr,iterator){if(arr.forEach){return arr.forEach(iterator)}for(var i=0;i<arr.length;i+=1){iterator(arr[i],i,arr)}};var _map=function(arr,iterator){if(arr.map){return arr.map(iterator)}var results=[];_each(arr,function(x,i,a){results.push(iterator(x,i,a))});return results};var _reduce=function(arr,iterator,memo){if(arr.reduce){return arr.reduce(iterator,memo)}_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo};var _keys=function(obj){if(Object.keys){return Object.keys(obj)}var keys=[];for(var k in obj){if(obj.hasOwnProperty(k)){keys.push(k)}}return keys};if(typeof process==="undefined"||!process.nextTick){if(typeof setImmediate==="function"){async.nextTick=function(fn){setImmediate(fn)};async.setImmediate=async.nextTick}else{async.nextTick=function(fn){setTimeout(fn,0)};async.setImmediate=async.nextTick}}else{async.nextTick=process.nextTick;if(typeof setImmediate!=="undefined"){async.setImmediate=function(fn){setImmediate(fn)}}else{async.setImmediate=async.nextTick}}async.each=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;_each(arr,function(x){iterator(x,only_once(done))});function done(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback()}}}};async.forEach=async.each;async.eachSeries=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;var iterate=function(){iterator(arr[completed],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback()}else{iterate()}}})};iterate()};async.forEachSeries=async.eachSeries;async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])};async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){callback=callback||function(){};if(!arr.length||limit<=0){return callback()}var completed=0;var started=0;var running=0;(function replenish(){if(completed>=arr.length){return callback()}while(running<limit&&started<arr.length){started+=1;running+=1;iterator(arr[started-1],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed>=arr.length){callback()}else{replenish()}}})}})()}};var doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}};var doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}};var doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}};var _asyncMap=function(eachfn,arr,iterator,callback){arr=_map(arr,function(x,i){return{index:i,value:x}});if(!callback){eachfn(arr,function(x,callback){iterator(x.value,function(err){callback(err)})})}else{var results=[];eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v;callback(err)})},function(err){callback(err,results)})}};async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.inject=async.reduce;async.foldl=async.reduce;async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)};async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];
arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter);async.filterSeries=doSeries(_filter);async.select=async.filter;async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(!v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject);async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){if(result){main_callback(x);main_callback=function(){}}else{callback()}})},function(err){main_callback()})};async.detect=doParallel(_detect);async.detectSeries=doSeries(_detect);async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(v){main_callback(true);main_callback=function(){}}callback()})},function(err){main_callback(false)})};async.any=async.some;async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(!v){main_callback(false);main_callback=function(){}}callback()})},function(err){main_callback(true)})};async.all=async.every;async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err){callback(err)}else{callback(null,{value:x,criteria:criteria})}})},function(err,results){if(err){return callback(err)}else{var fn=function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))}})};async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);var remainingTasks=keys.length;if(!remainingTasks){return callback()}var results={};var listeners=[];var addListener=function(fn){listeners.unshift(fn)};var removeListener=function(fn){for(var i=0;i<listeners.length;i+=1){if(listeners[i]===fn){listeners.splice(i,1);return}}};var taskComplete=function(){remainingTasks--;_each(listeners.slice(0),function(fn){fn()})};addListener(function(){if(!remainingTasks){var theCallback=callback;callback=function(){};theCallback(null,results)}});_each(keys,function(k){var task=_isArray(tasks[k])?tasks[k]:[tasks[k]];var taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}if(err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]});safeResults[k]=args;callback(err,safeResults);callback=function(){}}else{results[k]=args;async.setImmediate(taskComplete)}};var requires=task.slice(0,Math.abs(task.length-1))||[];var ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)&&!results.hasOwnProperty(k)};if(ready()){task[task.length-1](taskCallback,results)}else{var listener=function(){if(ready()){removeListener(listener);task[task.length-1](taskCallback,results)}};addListener(listener)}})};async.retry=function(times,task,callback){var DEFAULT_TIMES=5;var attempts=[];if(typeof times==="function"){callback=task;task=times;times=DEFAULT_TIMES}times=parseInt(times,10)||DEFAULT_TIMES;var wrappedTask=function(wrappedCallback,wrappedResults){var retryAttempt=function(task,finalAttempt){return function(seriesCallback){task(function(err,result){seriesCallback(!err||finalAttempt,{err:err,result:result})},wrappedResults)}};while(times){attempts.push(retryAttempt(task,!(times-=1)))}async.series(attempts,function(done,data){data=data[data.length-1];(wrappedCallback||callback)(data.err,data.result)})};return callback?wrappedTask():wrappedTask};async.waterfall=function(tasks,callback){callback=callback||function(){};if(!_isArray(tasks)){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length){return callback()}var wrapIterator=function(iterator){return function(err){if(err){callback.apply(null,arguments);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);var next=iterator.next();if(next){args.push(wrapIterator(next))}else{args.push(callback)}async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){callback=callback||function(){};if(_isArray(tasks)){eachfn.map(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)};async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)};async.series=function(tasks,callback){callback=callback||function(){};if(_isArray(tasks)){async.mapSeries(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){if(tasks.length){tasks[index].apply(null,arguments)}return fn.next()};fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn};return makeCallback(0)};async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]);cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){if(test()){iterator(function(err){if(err){return callback(err)}async.whilst(test,iterator,callback)})}else{callback()}};async.doWhilst=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}var args=Array.prototype.slice.call(arguments,1);if(test.apply(null,args)){async.doWhilst(iterator,test,callback)}else{callback()}})};async.until=function(test,iterator,callback){if(!test()){iterator(function(err){if(err){return callback(err)}async.until(test,iterator,callback)})}else{callback()}};async.doUntil=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}var args=Array.prototype.slice.call(arguments,1);if(!test.apply(null,args)){async.doUntil(iterator,test,callback)}else{callback()}})};async.queue=function(worker,concurrency){if(concurrency===undefined){concurrency=1}function _insert(q,data,pos,callback){if(!q.started){q.started=true}if(!_isArray(data)){data=[data]}if(data.length==0){return async.setImmediate(function(){if(q.drain){q.drain()}})}_each(data,function(task){var item={data:task,callback:typeof callback==="function"?callback:null};if(pos){q.tasks.unshift(item)}else{q.tasks.push(item)}if(q.saturated&&q.tasks.length===q.concurrency){q.saturated()}async.setImmediate(q.process)})}var workers=0;var q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,started:false,paused:false,push:function(data,callback){_insert(q,data,false,callback)},kill:function(){q.drain=null;q.tasks=[]},unshift:function(data,callback){_insert(q,data,true,callback)},process:function(){if(!q.paused&&workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();if(q.empty&&q.tasks.length===0){q.empty()}workers+=1;var next=function(){workers-=1;if(task.callback){task.callback.apply(task,arguments)}if(q.drain&&q.tasks.length+workers===0){q.drain()}q.process()};var cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers},idle:function(){return q.tasks.length+workers===0},pause:function(){if(q.paused===true){return}q.paused=true;q.process()},resume:function(){if(q.paused===false){return}q.paused=false;q.process()}};return q};async.priorityQueue=function(worker,concurrency){function _compareTasks(a,b){return a.priority-b.priority}function _binarySearch(sequence,item,compare){var beg=-1,end=sequence.length-1;while(beg<end){var mid=beg+(end-beg+1>>>1);if(compare(item,sequence[mid])>=0){beg=mid}else{end=mid-1}}return beg}function _insert(q,data,priority,callback){if(!q.started){q.started=true}if(!_isArray(data)){data=[data]}if(data.length==0){return async.setImmediate(function(){if(q.drain){q.drain()}})}_each(data,function(task){var item={data:task,priority:priority,callback:typeof callback==="function"?callback:null};q.tasks.splice(_binarySearch(q.tasks,item,_compareTasks)+1,0,item);if(q.saturated&&q.tasks.length===q.concurrency){q.saturated()}async.setImmediate(q.process)})}var q=async.queue(worker,concurrency);q.push=function(data,priority,callback){_insert(q,data,priority,callback)};delete q.unshift;return q};async.cargo=function(worker,payload){var working=false,tasks=[];var cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,drained:true,push:function(data,callback){if(!_isArray(data)){data=[data]}_each(data,function(task){tasks.push({data:task,callback:typeof callback==="function"?callback:null});cargo.drained=false;if(cargo.saturated&&tasks.length===payload){cargo.saturated()}});async.setImmediate(cargo.process)},process:function process(){if(working)return;if(tasks.length===0){if(cargo.drain&&!cargo.drained)cargo.drain();cargo.drained=true;return}var ts=typeof payload==="number"?tasks.splice(0,payload):tasks.splice(0,tasks.length);var ds=_map(ts,function(task){return task.data});if(cargo.empty)cargo.empty();working=true;worker(ds,function(){working=false;var args=arguments;_each(ts,function(data){if(data.callback){data.callback.apply(null,args)}});process()})},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);if(typeof console!=="undefined"){if(err){if(console.error){console.error(err)}}else if(console[name]){_each(args,function(x){console[name](x)})}}}]))}};async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var key=hasher.apply(null,args);if(key in memo){async.nextTick(function(){callback.apply(null,memo[key])})}else if(key in queues){queues[key].push(callback)}else{queues[key]=[callback];fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i].apply(null,arguments)}}]))}};memoized.memo=memo;memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}};async.times=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.map(counter,iterator,callback)};async.timesSeries=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.mapSeries(counter,iterator,callback)};async.seq=function(){var fns=arguments;return function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0];var nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}};async.compose=function(){return async.seq.apply(null,Array.prototype.reverse.call(arguments))};var _applyEach=function(eachfn,fns){var go=function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}else{return go}};async.applyEach=doParallel(_applyEach);async.applyEachSeries=doSeries(_applyEach);async.forever=function(fn,callback){function next(err){if(err){if(callback){return callback(err)}throw err}fn(next)}next()};if(typeof module!=="undefined"&&module.exports){module.exports=async}else if(typeof define!=="undefined"&&define.amd){define([],function(){return async})}else{root.async=async}})()}).call(this,require("FWaASH"))},{FWaASH:4}]},{},[1]);
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.RTC=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports={constraints:{video:true,audio:true},signaller:"//switchboard.rtc.io",room:undefined,channels:{chat:true},localContainer:"#l-video",remoteContainer:"#r-video",options:{plugins:[]}}},{}],2:[function(require,module,exports){var defaults=require("cog/defaults");var extend=require("cog/extend");var attach=require("rtc-attach");var capture=require("rtc-capture");var quickconnect=require("rtc-quickconnect");var chain=require("whisk/chain");var append=require("fdom/append");var tweak=require("fdom/classtweak");var qsa=require("fdom/qsa");var kgo=require("kgo");module.exports=function(config){var conference;config=defaults({},config,require("./defaultconfig.js"));conference=quickconnect(config.signaller,extend({expectedLocalStreams:1},config.opts,{room:config.room}));conference.on("call:ended",removeRemoteVideos).on("stream:added",remoteVideo(conference,config));Object.keys(config.channels||{}).forEach(function(name){var channelConfig=config.channels[name];conference.createDataChannel(name,channelConfig===true?null:channelConfig)});if(config.constraints){localVideo(conference,config)}return conference};function localVideo(qc,config){kgo(config)("capture",["constraints","options"],capture)("attach",["capture","options"],attach.local)("render-local",["attach"],chain([tweak("+rtc"),tweak("+localvideo"),append.to((config||{}).localContainer||"#l-video")]))("start-conference",["capture"],qc.addStream).on("error",reportError(qc,config))}function remoteVideo(qc,config){return function(id,stream){kgo({stream:stream})("attach",["stream"],attach)("render-remote",["attach"],function(el){el.dataset.peer=id;append.to((config||{}).remoteContainer||"#r-video",el)}).on("error",reportError(qc,config))}}function removeRemoteVideos(id){qsa('[data-peer="'+id+'"]').forEach(function(el){el.parentNode.removeChild(el)})}function reportError(qc,config){return function(err){}}},{"./defaultconfig.js":1,"cog/defaults":5,"cog/extend":6,"fdom/append":11,"fdom/classtweak":12,"fdom/qsa":13,kgo:14,"rtc-attach":16,"rtc-capture":17,"rtc-quickconnect":21,"whisk/chain":47}],3:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}throw TypeError('Uncaught, unspecified "error" event.')}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],4:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canMutationObserver=typeof window!=="undefined"&&window.MutationObserver;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}var queue=[];if(canMutationObserver){var hiddenDiv=document.createElement("div");var observer=new MutationObserver(function(){var queueList=queue.slice();queue.length=0;queueList.forEach(function(fn){fn()})});observer.observe(hiddenDiv,{attributes:true});return function nextTick(fn){if(!queue.length){hiddenDiv.setAttribute("yes","no")}queue.push(fn)}}if(canPost){window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],5:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],6:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],7:[function(require,module,exports){module.exports=function(target){function get(key){return target[key]}function set(key,value){target[key]=value}function remove(key){return delete target[key]}function keys(){return Object.keys(target)}function values(){return Object.keys(target).map(function(key){return target[key]})}if(typeof target!="object"){return target}return{get:get,set:set,remove:remove,"delete":remove,keys:keys,values:values}}},{}],8:[function(require,module,exports){"use strict";module.exports=function(input){var isString=typeof input=="string"||input instanceof String;var reNumeric=/^\-?\d+\.?\d*$/;var shouldParse;var firstChar;var lastChar;if(!isString||input.length<2){if(isString&&reNumeric.test(input)){return parseFloat(input)}return input}if(input==="true"||input==="false"){return input==="true"}if(input==="null"){return null}firstChar=input.charAt(0);lastChar=input.charAt(input.length-1);shouldParse=firstChar=="{"&&lastChar=="}"||firstChar=="["&&lastChar=="]"||firstChar=='"'&&lastChar=='"';if(shouldParse){try{return JSON.parse(input)}catch(e){}}return reNumeric.test(input)?parseFloat(input):input}},{}],9:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],10:[function(require,module,exports){"use strict";module.exports=function(fn,delay,opts){var lastExec=(opts||{}).leading!==false?0:Date.now();var trailing=(opts||{}).trailing;var timer;var queuedArgs;var queuedScope;trailing=trailing||trailing===undefined;function invokeDefered(){fn.apply(queuedScope,queuedArgs||[]);lastExec=Date.now()}return function(){var tick=Date.now();var elapsed=tick-lastExec;clearTimeout(timer);if(elapsed<delay){queuedArgs=[].slice.call(arguments,0);queuedScope=this;return trailing&&(timer=setTimeout(invokeDefered,delay-elapsed))}lastExec=tick;fn.apply(this,arguments)}}},{}],11:[function(require,module,exports){"use strict";var append=module.exports=function(){console.log("not yet implemented");return false};append.to=function(target,child){function append(el){var t=target;if(typeof t=="string"||t instanceof String){t=document.querySelector(t)}if(t&&typeof t.appendChild=="function"){t.appendChild(el);return el}}return child?append(child):append}},{}],12:[function(require,module,exports){"use strict";var reDelim=/[\s\,]\s*/;var opMappings={"+":"add","-":"remove","~":"toggle","!":"toggle"};module.exports=function(mods,element){var rules=mods.trim().split(reDelim).map(function(rule){return{op:opMappings[rule.charAt(0)],cls:rule.slice(1)}}).filter(function(rule){return rule.op});function tweak(el){if(!el.classList){return el}rules.forEach(function(rule){el.classList[rule.op](rule.cls)});return el}return element?tweak(element):tweak}},{}],13:[function(require,module,exports){"use strict";var classSelectorRE=/^\.([\w\-]+)$/;var idSelectorRE=/^#([\w\-]+)$/;var tagSelectorRE=/^[\w\-]+$/;module.exports=function(selector,scope){var idSearch;scope=scope||document;idSearch=scope===document&&idSelectorRE.test(selector);return idSearch?[scope.getElementById(RegExp.$1)]:Array.prototype.slice.call(classSelectorRE.test(selector)?scope.getElementsByClassName(RegExp.$1):tagSelectorRE.test(selector)?scope.getElementsByTagName(selector):scope.querySelectorAll(selector))}},{}],14:[function(require,module,exports){var run=require("./run"),EventEmitter=require("events").EventEmitter,fnRegex=/^function.*?\((.*?)\)/;var defer=typeof setImmediate==="function"?setImmediate:setTimeout;function newKgo(){var returnlessId=0,tasks={},results={},errorHandlers={},inFlight,defaultsDefined;function kgoFn(name,dependencies,fn){if(inFlight){throw"No tasks or defaults may be set after kgo is in flight"}if(arguments.length===1&&name!==null&&typeof name==="object"){if(defaultsDefined){throw"Defaults may be defined only once per kgo"}for(var key in name){if(key in tasks){throw"A task is already defined for "+key}results[key]=name[key]}defaultsDefined=true;return kgoFn}if(typeof name!=="string"){fn=dependencies;dependencies=name;name=(returnlessId++).toString()+"__returnless"}if(typeof dependencies==="function"){fn=dependencies;dependencies=[]}if(typeof fn!=="function"){throw new Error("No function provided for task number "+Object.keys(tasks).length+" ("+name+")")}if(name in results){throw"A default with the same name as this task ("+name+") has already been set"}tasks[name]={name:name,args:dependencies,fn:fn};return kgoFn}for(var key in EventEmitter.prototype){kgoFn[key]=EventEmitter.prototype[key]}kgoFn.apply(null,arguments);defer(function(){inFlight=true;run(tasks,results,kgoFn)});return kgoFn}module.exports=newKgo},{"./run":15,events:3}],15:[function(require,module,exports){var ignoreDependency=/^\!.+/;function Step(task,args,done){this._task=task;this._args=args;this._done=done}Step.prototype._count=1;Step.prototype._runs=0;Step.prototype.run=function(){var step=this,results=[],didError;this._task.fn.apply(this,this._args.concat([function(error,result){results.push(result);step._runs++;if(error){didError=true;step.done(error)}else if(!didError&&step._runs===step._count){step.done(null,results)}}]))};Step.prototype.count=function(number){this._parallel=true;this._count=number};Step.prototype.done=function(error,results){if(error){return this._done(error)}this._done(null,this._parallel?results:results[0])};function runTask(task,results,aboutToRun,done){var name=task.name,dependants=task.args,taskFunction=task.fn,args=[];if(dependants){for(var i=0;i<dependants.length;i++){var dependantName=dependants[i],ignore=dependantName.match(ignoreDependency);if(ignore){dependantName=dependantName.slice(1)}if(!(dependantName in results)){return}if(!ignore){args.push(results[dependantName])}}}var step=new Step(task,args,function(error,result){done(name,error,result)});aboutToRun(name);step.run()}function run(tasks,results,emitter){var currentTask;for(var key in tasks){currentTask=tasks[key];runTask(currentTask,results,function(name){delete tasks[name]},function(name,error,result){if(error){emitter.emit("error",error,name);return}results[name]=result;run(tasks,results,emitter)})}}function cloneAndRun(tasks,results,emitter){var todo={};for(var key in tasks){todo[key]=tasks[key]}run(todo,results,emitter)}module.exports=cloneAndRun},{}],16:[function(require,module,exports){var plugin=require("rtc-core/plugin");var extend=require("cog/extend");var attach=module.exports=function(stream,opts,callback){var URL=typeof window!="undefined"&&window.URL;var el;var pinst;if(typeof opts=="function"){callback=opts;opts={}}function attachToElement(s,o){var autoplay=(o||{}).autoplay;var elType="audio";var el=(o||{}).el;isValid=s&&typeof s.getVideoTracks=="function";if(isValid&&s.getVideoTracks().length>0){elType="video"}el=el||document.createElement(elType);if(URL&&URL.createObjectURL){el.src=URL.createObjectURL(stream)}else if(el.srcObject){el.srcObject=stream}else if(el.mozSrcObject){el.mozSrcObject=stream}if((o||{}).muted){el.muted=true;el.setAttribute("muted","")}if(autoplay===undefined||autoplay){el.play()}return el}pinst=plugin((opts||{}).plugins);if(pinst){return pinst.init(opts,function(err){if(err){return callback(err)}if(typeof pinst.attach!="function"){return callback(new Error("plugin must support the attach function"))}callback(null,pinst.attach(stream,opts))})}callback(null,attachToElement(stream,opts))};attach.local=function(stream,opts,callback){if(typeof opts=="function"){callback=opts;opts={}}attach(stream,extend({muted:true},opts),callback)}},{"cog/extend":6,"rtc-core/plugin":20}],17:[function(require,module,exports){var plugin=require("rtc-core/plugin");var detect=require("rtc-core/detect");navigator.getUserMedia=navigator.getUserMedia||detect.call(navigator,"getUserMedia");module.exports=function(constraints,opts,callback){var pinst;function handleCapture(stream){callback(null,stream)}if(typeof opts=="function"){callback=opts;opts={}}pinst=plugin((opts||{}).plugins);if(pinst){return pinst.init(opts,function(err){if(err){return callback(err)}if(typeof navigator.getUserMedia!="function"){return callback(new Error("plugin does not support media capture"))}navigator.getUserMedia(constraints,handleCapture,callback)})}if(typeof navigator.getUserMedia!="function"){return callback(new Error("getUserMedia not supported"))}navigator.getUserMedia(constraints,handleCapture,callback)}},{"rtc-core/detect":18,"rtc-core/plugin":20}],18:[function(require,module,exports){"use strict";var browser=require("detect-browser");var detect=module.exports=function(target,prefixes){var prefixIdx;var prefix;var testName;var hostObject=this||(typeof window!="undefined"?window:undefined);if(!hostObject){return}prefixes=(prefixes||["ms","o","moz","webkit"]).concat("");for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();return hostObject[target]=hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;detect.browser=browser.name;detect.browserVersion=detect.version=browser.version},{"detect-browser":19}],19:[function(require,module,exports){var browsers=[["chrome",/Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+)\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-6].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/iPad\;\sCPU\sOS\s([0-9\._]+)/],["ios",/iPhone\;\sCPU\siPhone\sOS\s([0-9\._]+)/],["safari",/Safari\/([0-9\._]+)/]];var match=browsers.map(match).filter(isMatch)[0];var parts=match&&match[3].split(/[._]/).slice(0,3);while(parts&&parts.length<3){parts.push("0")}exports.name=match&&match[0];exports.version=parts&&parts.join(".");function match(pair){return pair.concat(pair[1].exec(navigator.userAgent))}function isMatch(pair){return!!pair[2]}},{}],20:[function(require,module,exports){var detect=require("./detect");var requiredFunctions=["init"];function isSupported(plugin){return plugin&&typeof plugin.supported=="function"&&plugin.supported(detect)}function isValid(plugin){var supportedFunctions=requiredFunctions.filter(function(fn){return typeof plugin[fn]=="function"});return supportedFunctions.length===requiredFunctions.length}module.exports=function(plugins){return[].concat(plugins||[]).filter(isSupported).filter(isValid)[0]}},{"./detect":18}],21:[function(require,module,exports){(function(process){"use strict";var rtc=require("rtc-tools");var mbus=require("mbus");var cleanup=require("rtc-tools/cleanup");var debug=rtc.logger("rtc-quickconnect");var defaults=require("cog/defaults");var extend=require("cog/extend");var getable=require("cog/getable");var reTrailingSlash=/\/$/;module.exports=function(signalhost,opts){var hash=typeof location!="undefined"&&location.hash.slice(1);var signaller=require("rtc-signaller")(signalhost,opts);var ns=(opts||{}).ns||"";var room=(opts||{}).room;var debugging=(opts||{}).debug;var allowJoin=!(opts||{}).manualJoin;var profile={};var announced=false;var localStreams=[];var calls=signaller.calls=getable({});var channels={};var plugins=signaller.plugins=(opts||{}).plugins||[];var expectedLocalStreams=parseInt((opts||{}).expectedLocalStreams,10)||0;var announceTimer=0;function callCreate(id,pc,data){calls.set(id,{active:false,pc:pc,channels:getable({}),data:data,streams:[]})}function callEnd(id){var call=calls.get(id);if(!call){return}debug("ending call to: "+id);call.channels.keys().forEach(function(label){var channel=call.channels.get(label);var args=[id,channel,label];signaller.apply(signaller,["channel:closed"].concat(args));signaller.apply(signaller,["channel:closed:"+label].concat(args));channel.onopen=null});call.streams.forEach(function(stream){signaller("stream:removed",id,stream)});calls.delete(id);signaller("call:ended",id,call.pc);cleanup(call.pc)}function callStart(id,pc,data){var call=calls.get(id);var streams=[].concat(pc.getRemoteStreams());call.active=true;call.streams=[].concat(pc.getRemoteStreams());pc.onaddstream=createStreamAddHandler(id);pc.onremovestream=createStreamRemoveHandler(id);debug(signaller.id+" - "+id+" call start: "+streams.length+" streams");signaller("call:started",id,pc,data);process.nextTick(function(){streams.forEach(receiveRemoteStream(id))})}function checkReadyToAnnounce(){clearTimeout(announceTimer);if(!allowJoin){return}if(expectedLocalStreams&&localStreams.length<expectedLocalStreams){return}announceTimer=setTimeout(function(){var data=extend({},profile,{room:room});signaller.announce(data);announced=true},0)}function createStreamAddHandler(id){return function(evt){debug("peer "+id+" added stream");updateRemoteStreams(id);receiveRemoteStream(id)(evt.stream)}}function createStreamRemoveHandler(id){return function(evt){debug("peer "+id+" removed stream");updateRemoteStreams(id);signaller("stream:removed",id,evt.stream)}}function getActiveCall(peerId){var call=calls.get(peerId);if(!call){throw new Error("No active call for peer: "+peerId)}return call}function gotPeerChannel(channel,pc,data){var channelMonitor;function channelReady(){var call=calls.get(data.id);var args=[data.id,channel,data,pc];debug('reporting channel "'+channel.label+'" ready, have call: '+!!call);clearInterval(channelMonitor);channel.onopen=null;if(call){call.channels.set(channel.label,channel)}debug("triggering channel:opened events for channel: "+channel.label);signaller.apply(signaller,["channel:opened"].concat(args));signaller.apply(signaller,["channel:opened:"+channel.label].concat(args))}debug("channel "+channel.label+" discovered for peer: "+data.id);if(channel.readyState==="open"){return channelReady()}debug("channel not ready, current state = "+channel.readyState);channel.onopen=channelReady;channelMonitor=setInterval(function(){debug("checking channel state, current state = "+channel.readyState);if(channel.readyState==="open"){channelReady()}},500)}function handleLocalAnnounce(data){if(data&&typeof data.room!="undefined"){room=data.room}}function handlePeerAnnounce(data){var pc;var monitor;if(data.room!==room){return}pc=rtc.createConnection(opts,(opts||{}).constraints);signaller("peer:connect",data.id,pc,data);callCreate(data.id,pc,data);localStreams.forEach(function(stream,idx){pc.addStream(stream)});if(signaller.isMaster(data.id)){debug("is master, creating data channels: ",Object.keys(channels));Object.keys(channels).forEach(function(label){gotPeerChannel(pc.createDataChannel(label,channels[label]),pc,data)})}else{pc.ondatachannel=function(evt){var channel=evt&&evt.channel;if(!channel){return}if(channels[channel.label]!==undefined){gotPeerChannel(channel,pc,data)}}}debug("coupling "+signaller.id+" to "+data.id);monitor=rtc.couple(pc,data.id,signaller,extend({},opts,{logger:mbus("pc."+data.id,signaller)}));signaller("peer:couple",data.id,pc,data,monitor);monitor.once("connected",callStart.bind(null,data.id,pc,data));monitor.once("closed",callEnd.bind(null,data.id));if(signaller.isMaster(data.id)){monitor.createOffer()}}function handlePeerFilter(evt){evt.allow=evt.allow&&localStreams.length>=expectedLocalStreams}function handlePeerUpdate(data){var id=data&&data.id;var activeCall=id&&calls.get(id);if(id&&!activeCall){debug("received peer update from peer "+id+", no active calls");return handlePeerAnnounce(data)}}function receiveRemoteStream(id){var call=calls.get(id);return function(stream){signaller("stream:added",id,stream,call&&call.data)}}function updateRemoteStreams(id){var call=calls.get(id);if(call&&call.pc){call.streams=[].concat(call.pc.getRemoteStreams())}}if(!room){if(!hash){hash=location.hash=""+Math.pow(2,53)*Math.random()}room=ns+"#"+hash}if(debugging){rtc.logger.enable.apply(rtc.logger,Array.isArray(debug)?debugging:["*"])}signaller.on("peer:announce",handlePeerAnnounce);signaller.on("peer:update",handlePeerUpdate);signaller.on("peer:leave",callEnd);signaller.broadcast=signaller.addStream=function(stream){localStreams.push(stream);calls.values().forEach(function(data){data.pc.addStream(stream)});checkReadyToAnnounce();return signaller};signaller.endCalls=function(){calls.keys().forEach(callEnd)};signaller.close=function(){signaller.endCalls();signaller.leave()};signaller.createDataChannel=function(label,opts){calls.keys().forEach(function(peerId){var call=calls.get(peerId);var dc;if(call&&call.pc&&signaller.isMaster(peerId)){dc=call.pc.createDataChannel(label,opts);gotPeerChannel(dc,call.pc,call.data)}});channels[label]=opts||null;return signaller};signaller.join=function(){allowJoin=true;checkReadyToAnnounce()};signaller.reactive=function(){opts=opts||{};opts.reactive=true;return signaller};signaller.removeStream=function(stream){var localIndex=localStreams.indexOf(stream);calls.values().forEach(function(call){call.pc.removeStream(stream)});if(localIndex>=0){localStreams.splice(localIndex,1)}return signaller};signaller.requestChannel=function(targetId,label,callback){var call=getActiveCall(targetId);var channel=call&&call.channels.get(label);if(channel){callback(null,channel);return signaller}signaller.once("channel:opened:"+label,function(id,dc){callback(null,dc)});return signaller};signaller.requestStream=function(targetId,idx,callback){var call=getActiveCall(targetId);var stream;function waitForStream(peerId){if(peerId!==targetId){return}stream=call.pc.getRemoteStreams()[idx];if(stream){signaller.removeListener("stream:added",waitForStream);callback(null,stream)}}stream=call.pc.getRemoteStreams()[idx];if(stream){callback(null,stream);return signaller}signaller.on("stream:added",waitForStream);return signaller};signaller.profile=function(data){extend(profile,data);if(announced){signaller.announce(profile)}return signaller};signaller.waitForCall=function(targetId,callback){var call=calls.get(targetId);if(call&&call.active){callback(null,call.pc);return signaller}signaller.on("call:started",function handleNewCall(id){if(id===targetId){signaller.removeListener("call:started",handleNewCall);callback(null,calls.get(id).pc)}})};if(expectedLocalStreams){signaller.on("peer:filter",handlePeerFilter)}signaller.on("local:announce",handleLocalAnnounce);checkReadyToAnnounce();return signaller}}).call(this,require("_process"))},{_process:4,"cog/defaults":5,"cog/extend":6,"cog/getable":7,mbus:22,"rtc-signaller":25,"rtc-tools":40,"rtc-tools/cleanup":36}],22:[function(require,module,exports){var createTrie=require("array-trie");var reDelim=/[\.\:]/;var createBus=module.exports=function(namespace,parent,scope){var registry=createTrie();var feeds=[];function bus(name){var args=[].slice.call(arguments,1);var parts=getNameParts(name);var delimited=parts.join(".");var handlers=registry.get(parts)||[];var results;feeds.forEach(function(feed){feed({name:delimited,args:args})});results=[].concat(handlers).map(function(handler){return handler.apply(scope||this,args)});if(bus.parent){results=results.concat(bus.parent.apply(scope||this,[namespace.concat(parts)].concat(args)))}return results}function clear(name){if(name){registry.set(getNameParts(name),[])}else{registry=createTrie()}}function feed(handler){function stop(){feeds.splice(feeds.indexOf(handler),1)}feeds.push(handler);return stop}function getNameParts(name){return Array.isArray(name)?name:name.split(reDelim)}function off(name,handler){var handlers=registry.get(getNameParts(name));var idx=handlers?handlers.indexOf(handler):-1;if(idx>=0){handlers.splice(idx,1)}}function on(name,handler){var parts=getNameParts(name);var handlers=registry.get(parts);if(handlers){handlers.push(handler)}else{registry.set(parts,[handler])}return bus}function once(name,handler){return on(name,function handleEvent(){var result=handler.apply(this,arguments);bus.off(name,handleEvent);return result})}if(typeof namespace=="function"){parent=namespace;namespace=""}namespace=namespace&&namespace.split(reDelim)||[];bus.clear=bus.removeAllListeners=clear;bus.feed=feed;bus.on=bus.addListener=on;bus.once=once;bus.off=bus.removeListener=off;bus.parent=parent||namespace&&namespace.length>0&&createBus();return bus}},{"array-trie":24}],23:[function(require,module,exports){"use strict";function compileSearch(funcName,predicate,reversed,extraArgs,useNdarray,earlyOut){var code=["function ",funcName,"(a,l,h,",extraArgs.join(","),"){",earlyOut?"":"var i=",reversed?"l-1":"h+1",";while(l<=h){var m=(l+h)>>>1,x=a",useNdarray?".get(m)":"[m]"];if(earlyOut){if(predicate.indexOf("c")<0){code.push(";if(x===y){return m}else if(x<=y){")}else{code.push(";var p=c(x,y);if(p===0){return m}else if(p<=0){")}}else{code.push(";if(",predicate,"){i=m;")}if(reversed){code.push("l=m+1}else{h=m-1}")}else{code.push("h=m-1}else{l=m+1}")}code.push("}");if(earlyOut){code.push("return -1};")}else{code.push("return i};")}return code.join("")}function compileBoundsSearch(predicate,reversed,suffix,earlyOut){var result=new Function([compileSearch("A","x"+predicate+"y",reversed,["y"],false,earlyOut),compileSearch("B","x"+predicate+"y",reversed,["y"],true,earlyOut),compileSearch("P","c(x,y)"+predicate+"0",reversed,["y","c"],false,earlyOut),compileSearch("Q","c(x,y)"+predicate+"0",reversed,["y","c"],true,earlyOut),"function dispatchBsearch",suffix,"(a,y,c,l,h){if(a.shape){if(typeof(c)==='function'){return Q(a,(l===undefined)?0:l|0,(h===undefined)?a.shape[0]-1:h|0,y,c)}else{return B(a,(c===undefined)?0:c|0,(l===undefined)?a.shape[0]-1:l|0,y)}}else{if(typeof(c)==='function'){return P(a,(l===undefined)?0:l|0,(h===undefined)?a.length-1:h|0,y,c)}else{return A(a,(c===undefined)?0:c|0,(l===undefined)?a.length-1:l|0,y)}}}return dispatchBsearch",suffix].join(""));
return result()}module.exports={ge:compileBoundsSearch(">=",false,"GE"),gt:compileBoundsSearch(">",false,"GT"),lt:compileBoundsSearch("<",true,"LT"),le:compileBoundsSearch("<=",true,"LE"),eq:compileBoundsSearch("-",true,"EQ",true)}},{}],24:[function(require,module,exports){"use strict";var bounds=require("binary-search-bounds");module.exports=createTrie;function Trie(symbols,children,value){this.symbols=symbols;this.children=children;this.value=value}var proto=Trie.prototype;proto.set=function(s,value){if(s.shape){var v=this;var n=s.shape[0];for(var i=0;i<n;++i){var c=s.get(i);var j=bounds.ge(v.symbols,c);if(j<v.symbols.length&&v.symbols[j]===c){v=v.children[j]}else{var l=new Trie([],[],value);for(var k=n-1;k>i;--k){l=new Trie([s.get(k)],[l])}v.symbols.splice(j,0,c);v.children.splice(j,0,l);return value}}return v.value=value}else{var v=this;var n=s.length;for(var i=0;i<n;++i){var c=s[i];var j=bounds.ge(v.symbols,c);if(j<v.symbols.length&&v.symbols[j]===c){v=v.children[j]}else{var l=new Trie([],[],value);for(var k=n-1;k>i;--k){l=new Trie([s[k]],[l])}v.symbols.splice(j,0,c);v.children.splice(j,0,l);return value}}return v.value=value}};proto.get=function(s){if(s.shape){var v=this;var n=s.shape[0];for(var i=0;i<n;++i){var c=s.get(i);var j=bounds.eq(v.symbols,c);if(j<0){return}v=v.children[j]}return v.value}else{var v=this;var n=s.length;for(var i=0;i<n;++i){var c=s[i];var j=bounds.eq(v.symbols,c);if(j<0){return}v=v.children[j]}return v.value}};function createTrie(){return new Trie([],[])}},{"binary-search-bounds":23}],25:[function(require,module,exports){var extend=require("cog/extend");module.exports=function(messenger,opts){return require("./signaller.js")(messenger,extend({connect:require("./primus-loader")},opts))}},{"./primus-loader":33,"./signaller.js":35,"cog/extend":6}],26:[function(require,module,exports){module.exports={dataEvent:"data",openEvent:"open",closeEvent:"close",errorEvent:"error",writeMethod:"write",closeMethod:"close",leaveTimeout:3e3}},{}],27:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var extend=require("cog/extend");var roles=["a","b"];module.exports=function(signaller){function copyData(target,source){if(target&&source){for(var key in source){target[key]=source[key]}}return target}function dataAllowed(data){var evt={data:data,allow:true};signaller("peer:filter",evt);return evt.allow}return function(args,messageType,srcData,srcState,isDM){var data=args[0];var peer;debug("announce handler invoked, received data: ",data);if(data&&data.id&&data.id!==signaller.id){if(!dataAllowed(data)){return}peer=signaller.peers.get(data.id);signaller("peer:connected",data.id,data);if(peer&&!peer.inactive){debug("signaller: "+signaller.id+" received update, data: ",data);copyData(peer.data,data);return signaller("peer:update",data,srcData)}peer={id:data.id,roleIdx:[data.id,signaller.id].sort().indexOf(data.id),data:{}};copyData(peer.data,data);clearTimeout(peer.leaveTimer);peer.inactive=false;signaller.peers.set(data.id,peer);if(signaller.autoreply&&!isDM){signaller.to(data.id).send("/announce",signaller.attributes)}return signaller("peer:announce",data,peer)}}}},{"cog/extend":6,"cog/logger":9}],28:[function(require,module,exports){"use strict";module.exports=function(signaller,opts){return{announce:require("./announce")(signaller,opts),leave:require("./leave")(signaller,opts)}}},{"./announce":27,"./leave":29}],29:[function(require,module,exports){"use strict";module.exports=function(signaller,opts){return function(args){var data=args[0];var peer=signaller.peers.get(data&&data.id);if(peer){peer.leaveTimer=setTimeout(function(){peer.inactive=true;signaller("peer:leave",data.id,peer)},opts.leaveTimeout)}signaller("peer:disconnected",data.id,peer)}}},{}],30:[function(require,module,exports){(function(app){"use strict";var namespace="cuid",c=0,blockSize=4,base=36,discreteValues=Math.pow(base,blockSize),pad=function pad(num,size){var s="000000000"+num;return s.substr(s.length-size)},randomBlock=function randomBlock(){return pad((Math.random()*discreteValues<<0).toString(base),blockSize)},safeCounter=function(){c=c<discreteValues?c:0;c++;return c-1},api=function cuid(){var letter="c",timestamp=(new Date).getTime().toString(base),counter,fingerprint=api.fingerprint(),random=randomBlock()+randomBlock();counter=pad(safeCounter().toString(base),blockSize);return letter+timestamp+counter+fingerprint+random};api.slug=function slug(){var date=(new Date).getTime().toString(36),counter,print=api.fingerprint().slice(0,1)+api.fingerprint().slice(-1),random=randomBlock().slice(-2);counter=safeCounter().toString(36).slice(-4);return date.slice(-2)+counter+print+random};api.globalCount=function globalCount(){var cache=function calc(){var i,count=0;for(i in window){count++}return count}();api.globalCount=function(){return cache};return cache};api.fingerprint=function browserPrint(){return pad((navigator.mimeTypes.length+navigator.userAgent.length).toString(36)+api.globalCount().toString(36),4)};if(app.register){app.register(namespace,api)}else if(typeof module!=="undefined"){module.exports=api}else{app[namespace]=api}})(this.applitude||this)},{}],31:[function(require,module,exports){"use strict";var reVariable=/\{\{\s*([^\}]+?)\s*\}\}/;var mods=require("./mods");var formatter=module.exports=function(format,opts){var parts=[];var output=[];var chunk;var varname;var varParts;var match=reVariable.exec(format);var isNumeric;var outputIdx=0;var ignoreNumeric=(opts||{}).ignoreNumeric;while(match){chunk=format.slice(0,match.index);if(chunk){output[outputIdx++]=chunk}varParts=match[1].split(/\s*\|\s*/);match[1]=varParts[0];varname=parseInt(match[1],10);isNumeric=!isNaN(varname);if(ignoreNumeric&&isNumeric){output[outputIdx++]=match[0]}else{parts[parts.length]={idx:outputIdx++,numeric:isNumeric,varname:isNumeric?varname:match[1],modifiers:varParts.length>1?createModifiers(varParts.slice(1)):[]}}format=format.slice(match.index+match[0].length);match=reVariable.exec(format)}if(format){output[outputIdx++]=format}return collect(parts,output)};formatter.error=function(message){var format=formatter(message);return function(err){var output;if(!err){return}output=new Error(format.apply(null,Array.prototype.slice.call(arguments,1)));output._original=err;return output}};function collect(parts,resolved,indexShift){indexShift=indexShift||0;return function(){var output=[].concat(resolved);var unresolved;var ii;var part;var partIdx;var propNames;var val;var numericResolved=[];unresolved=parts.filter(function(part){return typeof output[part.idx]=="undefined"});ii=unresolved.length;for(;ii--;){part=unresolved[ii];if(typeof part=="object"){if(part.numeric){partIdx=part.varname-indexShift;if(arguments.length>partIdx){output[part.idx]=arguments[partIdx];if(numericResolved.indexOf(part.varname)<0){numericResolved[numericResolved.length]=part.varname}}}else if(arguments.length>0){propNames=(part.varname||"").split(".");output[part.idx]=arguments[arguments.length-1]||{};while(output[part.idx]&&propNames.length>0){val=output[part.idx][propNames.shift()];output[part.idx]=typeof val!="undefined"?val:""}}if(typeof output[part.idx]!="undefined"&&part.modifiers){output[part.idx]=applyModifiers(part.modifiers,output[part.idx])}}}unresolved=parts.filter(function(part){return part.numeric&&typeof output[part.idx]=="undefined"});if(unresolved.length===0){return output.join("")}return collect(parts,output,indexShift+numericResolved.length)}}function applyModifiers(modifiers,value){for(var ii=0,count=modifiers.length;ii<count;ii++){value=modifiers[ii](value)}return value}function createModifiers(modifierStrings){var modifiers=[];var parts;var fn;for(var ii=0,count=modifierStrings.length;ii<count;ii++){parts=modifierStrings[ii].split(":");fn=mods[parts[0].toLowerCase()];if(fn){modifiers[modifiers.length]=fn.apply(null,parts.slice(1))}}return modifiers}},{"./mods":32}],32:[function(require,module,exports){"use strict";exports.len=function(length,padder){var testInt=parseInt(padder,10);var isNumber;padder=!isNaN(testInt)?testInt:padder||" ";isNumber=typeof padder=="number";return function(input){var output=input.toString().slice(0,length);while(output.length<length){output=isNumber?padder+output:output+padder}return output}}},{}],33:[function(require,module,exports){"use strict";var reTrailingSlash=/\/$/;var formatter=require("formatter");var primusUrl=formatter("{{ signalhost }}{{ primusPath }}");module.exports=function(signalhost,opts,callback){var anchor=document.createElement("a");var script;var scriptSrc;if(typeof opts=="function"){callback=opts;opts={}}anchor.href=signalhost;scriptSrc=primusUrl({signalhost:signalhost.replace(reTrailingSlash,""),primusPath:(opts||{}).primusPath||"/rtc.io/primus.js"});script=document.querySelector('script[src="'+scriptSrc+'"]');if(script&&typeof Primus!="undefined"){return callback(null,Primus)}else if(script){script.addEventListener("load",function(){callback(null,Primus)});return}script=document.createElement("script");script.src=scriptSrc;script.onerror=callback;script.addEventListener("load",function(){if(anchor.pathname!=="/"){Primus.prototype.pathname=anchor.pathname.replace(reTrailingSlash,"")+Primus.prototype.pathname}callback(null,Primus)});document.body.appendChild(script)}},{formatter:31}],34:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var jsonparse=require("cog/jsonparse");module.exports=function(signaller,opts){var handlers=require("./handlers")(signaller,opts);function sendEvent(parts,srcState,data){var evtName=parts[0].slice(1);var args=parts.slice(2).map(jsonparse);signaller.apply(signaller,[evtName].concat(args).concat([srcState,data]))}return function(originalData){var data=originalData;var isMatch=true;var parts;var handler;var srcData;var srcState;var isDirectMessage=false;if(data&&data.slice(0,6)==="primus"){return}var id=signaller.id+"";debug("signaller "+id+" received data: "+originalData);if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){parts=data.slice(5+id.length).split("|").map(jsonparse);isDirectMessage=true;parts=parts.map(jsonparse)}}if(!isMatch){return}parts=parts||data.split("|").map(jsonparse);if(typeof parts[0]=="string"){srcData=parts[1];if(srcData&&srcData.id===signaller.id){return console.warn("got data from ourself, discarding")}srcState=signaller.peers.get(srcData&&srcData.id)||srcData;if(parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];if(typeof handler=="function"){handler(parts.slice(2),parts[0].slice(1),srcData,srcState,isDirectMessage)}else{sendEvent(parts,srcState,originalData)}}else{signaller("data",parts.slice(0,1).concat(parts.slice(2)),srcData,srcState,isDirectMessage)}}}}},{"./handlers":28,"cog/jsonparse":8,"cog/logger":9}],35:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var detect=require("rtc-core/detect");var defaults=require("cog/defaults");var extend=require("cog/extend");var mbus=require("mbus");var throttle=require("cog/throttle");var getable=require("cog/getable");var uuid=require("cuid");var WRITE_METHODS=["write","send"];var CLOSE_METHODS=["close","end"];var metadata={version:"3.1.0"};module.exports=function(messenger,opts){var autoreply=(opts||{}).autoreply;var connect=(opts||{}).connect;var localMeta={};var signaller=mbus("",(opts||{}).logger);var id=signaller.id=(opts||{}).id||uuid();var attributes=signaller.attributes={browser:detect.browser,browserVersion:detect.browserVersion,id:id,agent:"signaller@"+metadata.version};var peers=signaller.peers=getable({});var connected=false;var write;var close;var processor;var announceTimer=0;function announceOnReconnect(){signaller.announce()}function bindBrowserEvents(){messenger.addEventListener("message",function(evt){processor(evt.data)});messenger.addEventListener("open",handleMessengerOpen);messenger.addEventListener("close",handleMessengerClose)}function bindEvents(){messenger.on(opts.dataEvent,processor);messenger.on(opts.openEvent,handleMessengerOpen);messenger.on(opts.closeEvent,handleMessengerClose);messenger.on(opts.errorEvent,handleMessengerClose)}function connectToHost(url){if(typeof connect!="function"){return signaller("error",new Error("no connect function"))}connect(url,opts,function(err,socket){if(err){return signaller("error",err)}signaller._messenger=messenger=socket.connect(url);init()})}function createDataLine(args){return args.map(prepareArg).join("|")}function createMetadata(){return extend({},localMeta,{id:signaller.id})}function extractProp(name){return messenger[name]}function handleMessengerClose(err){if(err instanceof Error){console.log("socket closed with error: ",err)}connected=false;signaller("disconnected")}function handleMessengerOpen(){connected=true;signaller("open");signaller("connected")}function isClosing(){var isAbstraction=messenger&&typeof messenger.socket!="undefined";return isAbstraction?false:messenger&&typeof messenger.readyState!="undefined"&&messenger.readyState>=2}function isF(target){return typeof target=="function"}function init(){write=[opts.writeMethod].concat(WRITE_METHODS).map(extractProp).filter(isF)[0];close=[opts.closeMethod].concat(CLOSE_METHODS).map(extractProp).filter(isF)[0];signaller.process=processor=require("./processor")(signaller,opts);if(typeof write!="function"){throw new Error('provided messenger does not implement a "'+opts.writeMethod+'" write method')}if(typeof messenger.on=="function"){bindEvents()}else if(typeof messenger.addEventListener=="function"){bindBrowserEvents()}connected=messenger.connected||false;if(!connected){signaller.once("connected",function(){signaller.on("connected",announceOnReconnect)})}setTimeout(signaller.bind(signaller,"init"),0)}function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}var send=signaller.send=function(){var args=[].slice.call(arguments);var dataline;args.splice(1,0,createMetadata());dataline=createDataLine(args);if(isClosing()){return}if(!connected){return signaller.once("connected",function(){write.call(messenger,dataline)})}return write.call(messenger,dataline)};signaller.announce=function(data,sender){function sendAnnounce(){(sender||send)("/announce",attributes);signaller("local:announce",attributes)}clearTimeout(announceTimer);extend(attributes,data,{id:signaller.id});if(connected){signaller.removeListener("connected",announceOnReconnect);signaller.on("connected",announceOnReconnect)}return announceTimer=setTimeout(function(){if(!connected){return signaller.once("connected",sendAnnounce)}sendAnnounce()},(opts||{}).announceDelay||10)};signaller.isMaster=function(targetId){var peer=peers.get(targetId);return peer&&peer.roleIdx!==0};signaller.leave=signaller.close=function(){send("/leave",{id:id});signaller.removeListener("connected",announceOnReconnect);if(typeof close=="function"){close.call(messenger)}};signaller.metadata=function(data){if(arguments.length===0){return extend({},localMeta)}localMeta=extend({},data)};signaller.to=function(targetId){var sender=function(){var peer=signaller.peers.get(targetId);var args;if(!peer){throw new Error("Unknown peer: "+targetId)}if(peer.inactive){return}args=["/to",targetId].concat([].slice.call(arguments));args.splice(3,0,createMetadata());setTimeout(function(){var msg=createDataLine(args);debug("TX ("+targetId+"): "+msg);write.call(messenger,msg)},0)};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};opts=defaults({},opts,require("./defaults"));signaller.autoreply=autoreply===undefined||autoreply;if(typeof messenger=="string"||messenger instanceof String){connectToHost(messenger)}else{init()}signaller._messenger=messenger;signaller.process=processor;return signaller}},{"./defaults":26,"./processor":34,"cog/defaults":5,"cog/extend":6,"cog/getable":7,"cog/logger":9,"cog/throttle":10,cuid:30,mbus:22,"rtc-core/detect":18}],36:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc/cleanup");var CANNOT_CLOSE_STATES=["closed"];var EVENTS_DECOUPLE_BC=["addstream","datachannel","icecandidate","negotiationneeded","removestream","signalingstatechange"];var EVENTS_DECOUPLE_AC=["iceconnectionstatechange"];module.exports=function(pc){var currentState=pc.iceConnectionState;var canClose=CANNOT_CLOSE_STATES.indexOf(currentState)<0;function decouple(events){events.forEach(function(evtName){if(pc["on"+evtName]){pc["on"+evtName]=null}})}decouple(EVENTS_DECOUPLE_BC);if(canClose){debug("attempting connection close, current state: "+pc.iceConnectionState);pc.close()}setTimeout(function(){decouple(EVENTS_DECOUPLE_AC)},100)}},{"cog/logger":9}],37:[function(require,module,exports){"use strict";var mbus=require("mbus");var queue=require("rtc-taskqueue");var cleanup=require("./cleanup");var monitor=require("./monitor");var detect=require("./detect");var findPlugin=require("rtc-core/plugin");var CLOSED_STATES=["closed","failed"];function couple(pc,targetId,signaller,opts){var debugLabel=(opts||{}).debugLabel||"rtc";var debug=require("cog/logger")(debugLabel+"/couple");var mon=monitor(pc,targetId,signaller,(opts||{}).logger);var emit=mbus("",mon);var queuedCandidates=[];var sdpFilter=(opts||{}).sdpfilter;var reactive=(opts||{}).reactive;var offerTimeout;var endOfCandidates=true;var plugin=findPlugin((opts||{}).plugins);var disconnectTimeout=(opts||{}).disconnectTimeout||1e4;var disconnectTimer;var isMaster=signaller.isMaster(targetId);var q=queue(pc,opts);function createOrRequestOffer(){if(!isMaster){return signaller.to(targetId).send("/negotiate")}q.createOffer()}function debounceOffer(){debug("debouncing offer");clearTimeout(offerTimeout);offerTimeout=setTimeout(q.createOffer,50)}function decouple(){debug("decoupling "+signaller.id+" from "+targetId);mon.stop();cleanup(pc);signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleCandidate);signaller.removeListener("negotiate",handleNegotiateRequest)}function handleCandidate(data){q.addIceCandidate(data)}function handleSdp(sdp,src){emit("sdp.remote",sdp);if(!src||src.id!==targetId){return}q.setRemoteDescription(sdp)}function handleConnectionClose(){debug("captured pc close, iceConnectionState = "+pc.iceConnectionState);decouple()}function handleDisconnect(){debug("captured pc disconnect, monitoring connection status");disconnectTimer=setTimeout(function(){debug("manually closing connection after disconnect timeout");pc.close()},disconnectTimeout);mon.on("statechange",handleDisconnectAbort)}function handleDisconnectAbort(){debug("connection state changed to: "+pc.iceConnectionState);resetDisconnectTimer();if(CLOSED_STATES.indexOf(pc.iceConnectionState)>=0){return mon("closed")}mon.once("disconnect",handleDisconnect)}function handleLocalCandidate(evt){if(evt.candidate){resetDisconnectTimer();emit("ice.local",evt.candidate);signaller.to(targetId).send("/candidate",evt.candidate);endOfCandidates=false}else if(!endOfCandidates){endOfCandidates=true;emit("ice.gathercomplete");signaller.to(targetId).send("/endofcandidates",{})}}function handleNegotiateRequest(src){if(src.id===targetId){emit("negotiate.request",src.id);debounceOffer()}}function resetDisconnectTimer(){mon.off("statechange",handleDisconnectAbort);debug("reset disconnect timer, state: "+pc.iceConnectionState);clearTimeout(disconnectTimer)}if(reactive){pc.onnegotiationneeded=function(){emit("negotiate.renegotiate");createOrRequestOffer()}}pc.onicecandidate=handleLocalCandidate;q.on("sdp.local",function(desc){signaller.to(targetId).send("/sdp",desc)});signaller.on("sdp",handleSdp);signaller.on("candidate",handleCandidate);if(isMaster){signaller.on("negotiate",handleNegotiateRequest)}mon.once("closed",handleConnectionClose);mon.once("disconnected",handleDisconnect);mon.createOffer=createOrRequestOffer;return mon}module.exports=couple},{"./cleanup":36,"./detect":38,"./monitor":41,"cog/logger":9,mbus:22,"rtc-core/plugin":20,"rtc-taskqueue":42}],38:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":18}],39:[function(require,module,exports){"use strict";var debug=require("cog/logger")("generators");var detect=require("./detect");var defaults=require("cog/defaults");var mappings={create:{dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};var iceServerGenerator=function(){return[]};exports.config=function(config){var iceServerGenerator=(config||{}).iceServerGenerator;return defaults({},config,{iceServers:typeof iceServerGenerator=="function"?iceServerGenerator():[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;var out;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});out=defaults({},constraints,generated);debug("generated connection constraints: ",out);return out}},{"./detect":38,"cog/defaults":5,"cog/logger":9}],40:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");var findPlugin=require("rtc-core/plugin");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");exports.couple=require("./couple");exports.createConnection=function(opts,constraints){var plugin=findPlugin((opts||{}).plugins);var config=gen.config(opts);var constraints=gen.connectionConstraints(opts,constraints);if(plugin&&typeof plugin.createConnection=="function"){return plugin.createConnection(config,constraints)}else{return new((opts||{}).RTCPeerConnection||RTCPeerConnection)(config,constraints)}}},{"./couple":37,"./detect":38,"./generators":39,"cog/logger":9,"rtc-core/plugin":20}],41:[function(require,module,exports){"use strict";var mbus=require("mbus");var stateMappings={completed:"connected"};var peerStateEvents=["signalingstatechange","iceconnectionstatechange"];module.exports=function(pc,targetId,signaller,parentBus){var monitor=mbus("",parentBus);var state;function checkState(){var newState=getMappedState(pc.iceConnectionState);monitor("statechange",pc,newState);if(state!==newState){monitor(newState);state=newState}}function handleClose(){monitor("closed")}function handlePeerLeave(peerId){if(peerId!==targetId){return}monitor("closed")}pc.addEventListener("close",handleClose);peerStateEvents.forEach(function(evtName){pc.addEventListener(evtName,checkState)});monitor.stop=function(){pc.removeEventListener("close",handleClose);peerStateEvents.forEach(function(evtName){pc.removeEventListener(evtName,checkState)});if(signaller&&typeof signaller.removeListener=="function"){signaller.removeListener("peer:leave",handlePeerLeave)}};monitor.checkState=checkState;if(!pc){return monitor}state=getMappedState(pc.iceConnectionState);if(signaller&&typeof signaller.on=="function"){signaller.on("peer:leave",handlePeerLeave)}return monitor};function getMappedState(state){return stateMappings[state]||state}},{mbus:22}],42:[function(require,module,exports){var detect=require("rtc-core/detect");var zip=require("whisk/zip");var findPlugin=require("rtc-core/plugin");var PriorityQueue=require("priorityqueuejs");var checkCandidate=require("rtc-validator/candidate");var sdpclean=require("rtc-sdpclean");var PRIORITY_LOW=100;var PRIORITY_WAIT=1e3;var DEFAULT_PRIORITIES=["candidate","setLocalDescription","setRemoteDescription","createAnswer","createOffer"];var METHOD_EVENTS={setLocalDescription:"setlocaldesc",setRemoteDescription:"setremotedesc",createOffer:"offer",createAnswer:"answer"};module.exports=function(pc,opts){var queue=new PriorityQueue(orderTasks);var tq=require("mbus")("",(opts||{}).logger);var priorities=(opts||{}).priorities||DEFAULT_PRIORITIES;var plugin=findPlugin((opts||{}).plugins);var checkQueueTimer=0;var currentTask;var defaultFail=tq.bind(tq,"fail");var RTCSessionDescription=(opts||{}).RTCSessionDescription||detect("RTCSessionDescription");var RTCIceCandidate=(opts||{}).RTCIceCandidate||detect("RTCIceCandidate");function abortQueue(err){console.error(err)}function applyCandidate(task,next){var candidate;var data=task.args[0];if(!data.candidate){return next()}try{candidate=createIceCandidate(data);pc.addIceCandidate(candidate);tq("ice.remote.applied",candidate)}catch(e){tq("ice.remote.invalid",candidate);return next(e)}next()}function checkQueue(){var next=!queue.isEmpty()&&!currentTask&&queue.peek();var ready=next&&testReady(next);var retry=!queue.isEmpty()&&isNotClosed(pc);if(!ready){return retry&&triggerQueueCheck(100)}currentTask=queue.deq();currentTask.fn(currentTask,function(err){var fail=currentTask.fail||defaultFail;var pass=currentTask.pass;var taskName=currentTask.name;currentTask=null;if(err){console.error(taskName+" task failed: ",err);return fail(err)}if(typeof pass=="function"){pass.apply(null,[].slice.call(arguments,1))}triggerQueueCheck()})}function cleansdp(desc){var sdpErrors=[];var sdp=desc&&sdpclean(desc.sdp,{collector:sdpErrors});if(desc&&sdp!==desc.sdp){console.info("invalid lines removed from sdp: ",sdpErrors);desc.sdp=sdp}return desc}function completeConnection(){if(pc.signalingState==="have-remote-offer"){return tq.createAnswer()}}function createIceCandidate(data){if(plugin&&typeof plugin.createIceCandidate=="function"){return plugin.createIceCandidate(data)}return new RTCIceCandidate(data)}function createSessionDescription(data){if(plugin&&typeof plugin.createSessionDescription=="function"){return plugin.createSessionDescription(data)}return new RTCSessionDescription(data)}function emitSdp(sdp){tq("sdp.local",pc.localDescription)}function enqueue(name,handler,opts){return function(){var args=[].slice.call(arguments);if(opts&&typeof opts.processArgs=="function"){args=args.map(opts.processArgs)}queue.enq({args:args,name:name,fn:handler,checks:[isNotClosed].concat((opts||{}).checks||[]),pass:(opts||{}).pass,fail:(opts||{}).fail});triggerQueueCheck()}}function execMethod(task,next){var fn=pc[task.name];var eventName=METHOD_EVENTS[task.name]||(task.name||"").toLowerCase();var cbArgs=[success,fail];var isOffer=task.name==="createOffer";function fail(err){tq.apply(tq,["negotiate.error",task.name,err].concat(task.args));next(err)}function success(){tq.apply(tq,[["negotiate",eventName,"ok"],task.name].concat(task.args));next.apply(null,[null].concat([].slice.call(arguments)))}if(typeof fn!="function"){return next(new Error('cannot call "'+task.name+'" on RTCPeerConnection'))}tq.apply(tq,["negotiate."+eventName].concat(task.args));fn.apply(pc,task.args.concat(cbArgs).concat(isOffer?generateConstraints():[]))}function extractCandidateEventData(data){if(data.srcElement&&data.candidate){data=data.candidate}return data}function generateConstraints(){var allowedKeys={offertoreceivevideo:"OfferToReceiveVideo",offertoreceiveaudio:"OfferToReceiveAudio",icerestart:"IceRestart",voiceactivitydetection:"VoiceActivityDetection"};var constraints={OfferToReceiveVideo:true,OfferToReceiveAudio:true};Object.keys(opts||{}).forEach(function(key){if(allowedKeys[key.toLowerCase]){constraints[allowedKeys[key.toLowerCase()]]=opts[key]}});return{mandatory:constraints}}function hasLocalOrRemoteDesc(pc,task){return pc.localDescription!==null||pc.remoteDescription!==null}function isNotNegotiating(pc){return pc.signalingState!=="have-local-offer"}function isNotClosed(pc){return pc.signalingState!=="closed"}function isStable(pc){return pc.signalingState==="stable"}function isValidCandidate(pc,data){return checkCandidate(data.args[0]).length===0}function orderTasks(a,b){var tasks=[a,b];var readiness=tasks.map(testReady);var taskPriorities=tasks.map(zip(readiness)).map(function(args){var priority=priorities.indexOf(args[0].name);return args[1]?priority>=0?priority:PRIORITY_LOW:PRIORITY_WAIT});return taskPriorities[1]-taskPriorities[0]}function testReady(task){return(task.checks||[]).reduce(function(memo,check){return memo&&check(pc,task)},true)}function triggerQueueCheck(wait){clearTimeout(checkQueueTimer);checkQueueTimer=setTimeout(checkQueue,wait||5)}tq.addIceCandidate=enqueue("addIceCandidate",applyCandidate,{processArgs:extractCandidateEventData,checks:[hasLocalOrRemoteDesc,isValidCandidate]});tq.setLocalDescription=enqueue("setLocalDescription",execMethod,{processArgs:cleansdp,pass:emitSdp});tq.setRemoteDescription=enqueue("setRemoteDescription",execMethod,{processArgs:createSessionDescription,pass:completeConnection});tq.createOffer=enqueue("createOffer",execMethod,{checks:[isNotNegotiating],pass:tq.setLocalDescription});tq.createAnswer=enqueue("createAnswer",execMethod,{pass:tq.setLocalDescription});return tq}},{mbus:22,priorityqueuejs:43,"rtc-core/detect":18,"rtc-core/plugin":20,"rtc-sdpclean":44,"rtc-validator/candidate":45,"whisk/zip":46}],43:[function(require,module,exports){module.exports=PriorityQueue;function PriorityQueue(comparator){this._comparator=comparator||PriorityQueue.DEFAULT_COMPARATOR;this._elements=[]}PriorityQueue.DEFAULT_COMPARATOR=function(a,b){if(a instanceof Number&&b instanceof Number){return a-b}else{a=a.toString();b=b.toString();if(a==b)return 0;return a>b?1:-1}};PriorityQueue.prototype.isEmpty=function(){return this.size()===0};PriorityQueue.prototype.peek=function(){if(this.isEmpty())throw new Error("PriorityQueue is empty");return this._elements[0]};PriorityQueue.prototype.deq=function(){var first=this.peek();var last=this._elements.pop();var size=this.size();if(size===0)return first;this._elements[0]=last;var current=0;while(current<size){var largest=current;var left=2*current+1;var right=2*current+2;if(left<size&&this._compare(left,largest)>0){largest=left}if(right<size&&this._compare(right,largest)>0){largest=right}if(largest===current)break;this._swap(largest,current);current=largest}return first};PriorityQueue.prototype.enq=function(element){var size=this._elements.push(element);var current=size-1;while(current>0){var parent=Math.floor((current-1)/2);if(this._compare(current,parent)<0)break;this._swap(parent,current);current=parent}return size};PriorityQueue.prototype.size=function(){return this._elements.length};PriorityQueue.prototype.forEach=function(fn){return this._elements.forEach(fn)};PriorityQueue.prototype._compare=function(a,b){return this._comparator(this._elements[a],this._elements[b])};PriorityQueue.prototype._swap=function(a,b){var aux=this._elements[a];this._elements[a]=this._elements[b];this._elements[b]=aux}},{}],44:[function(require,module,exports){var validators=[[/^(a\=candidate.*)$/,require("rtc-validator/candidate")]];var reSdpLineBreak=/(\r?\n|\\r\\n)/;module.exports=function(input,opts){var lineBreak=detectLineBreak(input);var lines=input.split(lineBreak);var collector=(opts||{}).collector;lines=lines.filter(function(line){var validator=validators.reduce(function(memo,data,idx){return typeof memo!="undefined"?memo:data[0].exec(line)&&{line:line.replace(data[0],"$1"),fn:data[1]}},undefined);var errors=validator?validator.fn(validator.line):[];if(collector){errors.forEach(function(err){collector.push(err)})}return errors.length===0});return lines.join(lineBreak)};function detectLineBreak(input){var match=reSdpLineBreak.exec(input);return match&&match[0]}},{"rtc-validator/candidate":45}],45:[function(require,module,exports){var debug=require("cog/logger")("rtc-validator");var rePrefix=/^(?:a=)?candidate:/;var reIP=/^(\d+\.){3}\d+$/;var partValidation=[[/.+/,"invalid foundation component","foundation"],[/\d+/,"invalid component id","component-id"],[/(UDP|TCP)/i,"transport must be TCP or UDP","transport"],[/\d+/,"numeric priority expected","priority"],[reIP,"invalid connection address","connection-address"],[/\d+/,"invalid connection port","connection-port"],[/typ/,'Expected "typ" identifier',"type classifier"],[/.+/,"Invalid candidate type specified","candidate-type"]];module.exports=function(data){var errors=[];var candidate=data&&(data.candidate||data);var prefixMatch=candidate&&rePrefix.exec(candidate);var parts=prefixMatch&&candidate.slice(prefixMatch[0].length).split(/\s/);
if(!candidate){return[new Error("empty candidate")]}if(!prefixMatch){return[new Error("candidate did not match expected sdp line format")]}errors=errors.concat(parts.map(validateParts)).filter(Boolean);return errors};function validateParts(part,idx){var validator=partValidation[idx];if(validator&&!validator[0].test(part)){debug(validator[2]+" part failed validation: "+part);return new Error(validator[1])}}},{"cog/logger":9}],46:[function(require,module,exports){module.exports=function(){var targets=[].slice.call(arguments);return function(item,index){return[item].concat(targets.map(function(val){return val[index]}))}}},{}],47:[function(require,module,exports){module.exports=function(fns){fns=[].concat(fns||[]).concat([].slice.call(arguments,1));return function(value){return fns.reduce(function(memo,fn){var result=fn(memo);return result!==undefined?result:memo},value||0)}}},{}]},{},[2])(2)});